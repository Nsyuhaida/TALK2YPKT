<script>
// --- CONFIGURATION ---
const firebaseConfig={
  apiKey:"AIzaSyDjsNiteoay79tpavm_dfCcKHhRvBfU0Tk",
  authDomain:"e-complaint-8nu9kp.firebaseapp.com",
  projectId:"e-complaint-8nu9kp"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();
const auth=firebase.auth();

// === 1. LOGIN SYSTEM ===
function checkPin() {
    const pin = document.getElementById('secretPin').value;
    const btn = document.querySelector('.pin-box button');
    
    if(pin === "1234") { 
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> VERIFYING...';
        auth.signInWithEmailAndPassword("timbalanpengarah@ypkt.gov.my", "ypkt0101").then(() => {
            document.getElementById('pinScreen').style.display = 'none'; 
            document.getElementById('mainApp').classList.remove('hidden'); 
            loadPendingList();
            setupCanvas();
        }).catch(e => {
            btn.innerHTML = '<i class="fa-solid fa-lock-open"></i> MASUK';
            Swal.fire("Ralat Login", "Sistem gagal log masuk.", "error");
        });
    } else {
        Swal.fire({icon: 'error', title: 'PIN Salah', text: 'Sila masukkan kod yang betul.', background: '#1e293b', color: '#fff'});
        document.getElementById('secretPin').value = "";
    }
}

// === 2. LOAD LIST ===
function loadPendingList() {
    const container = document.getElementById('pendingList');
    const msg = document.getElementById('loadingMsg');
    
    db.collection("complaint").onSnapshot((snapshot) => {
        let html = "";
        let count = 0;

        snapshot.forEach(doc => {
            const d = doc.data();
            
            // Logic Check: Status belum approve/reject DAN bahagian teknikal dah siap semak
            const status = d.approvalStatus || d.approvalstatus || "";
            const statusLower = status.toLowerCase().trim();
            const isNotDecided = (statusLower !== "approve" && statusLower !== "reject");
            
            // Check tarikh teknikal (support pelbagai ejaan field)
            const techDate = d.section3Date || d.section3date || d.tarikhSemakan;
            const isTechDone = (techDate != null); 

            if(isNotDecided && isTechDone) {
                count++;
                
                // Ambil data untuk kad (support pelbagai ejaan)
                const type = d.assetType || d.assettype || d.jenisAset || "Aset Umum";
                const name = d.name || d.Name || d.fullname || d.nama || "Tanpa Nama";
                const dateVal = d.date || d.Date || d.timestamp || d.tarikhAduan;

                let icon = "fa-box";
                if(type.toLowerCase().includes("komputer") || type.toLowerCase().includes("laptop")) icon = "fa-computer";
                if(type.toLowerCase().includes("pencetak") || type.toLowerCase().includes("printer")) icon = "fa-print";
                
                html += `
                <div class="pending-card" onclick="openDetail('${doc.id}')">
                    <div class="card-left">
                        <div class="asset-icon"><i class="fa-solid ${icon}"></i></div>
                        <div class="card-info">
                            <h3>${type}</h3>
                            <div class="meta">
                                <span><i class="fa-solid fa-user"></i> ${name}</span>
                                <span><i class="fa-solid fa-calendar"></i> ${formatDate(dateVal)}</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-right">
                        <div class="status-badge">READY</div>
                        <div><i class="fa-solid fa-arrow-right" style="color:var(--gold)"></i></div>
                    </div>
                </div>`;
            }
        });

        if(count === 0) {
            msg.innerHTML = "Tiada permohonan yang menunggu kelulusan.";
            msg.style.display = 'block';
            container.innerHTML = "";
        } else {
            msg.style.display = 'none';
            container.innerHTML = html;
        }
    });
}

// === 3. OPEN DETAIL (BAHAGIAN INI DIBETULKAN UNTUK BACA DATA) ===
let currentId = "";

async function openDetail(id) {
    currentId = id;
    Swal.fire({title:'Mengambil Data...', didOpen:()=>{Swal.showLoading()}});
    
    try {
        const doc = await db.collection("complaint").doc(id).get();
        const d = doc.data();
        Swal.close();

        document.getElementById('dashboardView').classList.add('hidden');
        document.getElementById('approvalForm').classList.remove('hidden');

        // --- MAPPING DATA (Saya tambah variasi ejaan field supaya confirm masuk) ---
        
        // SEC 1: ADUAN
        setText('v_name', d.name || d.Name || d.fullname || d.nama || "-"); 
        setText('v_date', formatDate(d.date || d.Date || d.timestamp || d.tarikhAduan));
        setText('v_dept', d.department || d.Department || d.bahagian || d.unit || "-");
        setText('v_assettype', d.assetType || d.assettype || d.jenisAset || "-");
        setText('v_brand', d.brand || d.Brand || d.jenama || d.model || "-");
        setText('v_serial', d.serialNumber || d.serialnumber || d.noSiri || "-");
        setText('v_damage', d.damageDescription || d.damagedescription || d.kerosakan || d.masalah || "-");

        // SEC 2: PEGAWAI ASET
        setText('v_sec2_name', d.officerName || d.pegawaiAsetName || d.section2Name || d.section2name || "-"); 
        setText('v_sec2_date', formatDate(d.section2Date || d.section2date || d.tarikhPemeriksaan));
        setText('v_sec2_rec', d.recommendationSection2 || d.recommendationsection2 || d.syorPegawaiAset || "-");

        // SEC 3: TEKNIKAL (IT)
        setText('v_sec3_name', d.section3NamePosition || d.section3nameposition || d.technicianName || "-");
        setText('v_sec3_date', formatDate(d.section3Date || d.section3date || d.tarikhSemakan));
        
        // Format Duit (Cost)
        let cost = d.estimatedMaintenanceCost || d.estimatedmaintenancecost || d.kosAnggaran || "0";
        setText('v_sec3_cost', "RM " + cost);
        
        setText('v_sec3_rec', d.recommendSection3 || d.recommendsection3 || d.syorTeknikal || "-");

        // --- FORM PENGARAH ---
        // Kalau data dah ada, paparkan. Kalau tak, letak default
        document.getElementById('app_name').value = d.approverName || d.approvername || "ENCIK ASHRI";
        document.getElementById('app_pos').value = d.approverPosition || d.approverposition || "TIMBALAN PENGARAH";
        document.getElementById('app_comment').value = d.approvalComment || d.approvalcomment || "";
        document.getElementById('app_status').value = d.approvalStatus || d.approvalstatus || "Pending";

        clearSignature();
        // Kalau ada signature lama, load (optional, buat masa ni kita clear dulu)
        setTimeout(setupCanvas, 300);

    } catch(e) {
        Swal.fire("Ralat", "Gagal data: " + e.message, "error");
        console.error(e); // Tengok console log kalau error
    }
}

function setText(id, val) { 
    const el = document.getElementById(id); 
    if(el) el.innerText = val; 
}

function formatDate(timestamp) {
    if(!timestamp) return "-";
    // Convert Firebase Timestamp to JS Date
    let dateObj = timestamp;
    if(timestamp.toDate) dateObj = timestamp.toDate();
    
    // Format kepada DD/MM/YYYY
    try {
        return new Date(dateObj).toLocaleDateString('en-GB'); 
    } catch(e) {
        return timestamp; // Kalau format pelik, return string asal
    }
}

function showDashboard() {
    document.getElementById('approvalForm').classList.add('hidden');
    document.getElementById('dashboardView').classList.remove('hidden');
    loadPendingList(); // Reload list bila balik ke dashboard
}

// === 4. SIGNATURE ===
let currentSigMode = 'draw';
let canvas, ctx, isDrawing=false, uploadedSigData=null;

function switchSigMode(mode) {
    currentSigMode = mode;
    document.getElementById('btnDraw').className = mode === 'draw' ? 'tab-btn active' : 'tab-btn';
    document.getElementById('btnUpload').className = mode === 'upload' ? 'tab-btn active' : 'tab-btn';
    if(mode === 'draw') {
        document.getElementById('areaDraw').classList.remove('hidden');
        document.getElementById('areaUpload').classList.add('hidden');
        setupCanvas();
    } else {
        document.getElementById('areaDraw').classList.add('hidden');
        document.getElementById('areaUpload').classList.remove('hidden');
    }
}
function setupCanvas(){
    canvas=document.getElementById('sigCanvas'); if(!canvas) return;
    ctx=canvas.getContext('2d');
    const rect = canvas.parentElement.getBoundingClientRect();
    canvas.width = rect.width; canvas.height = 160;
    ctx.lineWidth=3; ctx.lineJoin='round'; ctx.lineCap='round'; ctx.strokeStyle='#000';
    canvas.onmousedown=start; canvas.onmousemove=draw; canvas.onmouseup=end; canvas.onmouseleave=end;
    canvas.ontouchstart=(e)=>{e.preventDefault();start(e.touches[0])};
    canvas.ontouchmove=(e)=>{e.preventDefault();draw(e.touches[0])};
    canvas.ontouchend=end;
}
function start(e){isDrawing=true; ctx.beginPath(); ctx.moveTo(e.clientX-canvas.getBoundingClientRect().left, e.clientY-canvas.getBoundingClientRect().top);}
function draw(e){if(!isDrawing)return; ctx.lineTo(e.clientX-canvas.getBoundingClientRect().left, e.clientY-canvas.getBoundingClientRect().top); ctx.stroke();}
function end(){isDrawing=false;}
function clearSignature(){ if(ctx) ctx.clearRect(0,0,canvas.width,canvas.height); uploadedSigData=null; document.getElementById('sigFile').value=""; document.getElementById('sigPreview').style.display='none';}
function previewSig(input){
    if(input.files[0]){
        const r=new FileReader();
        r.onload=(e)=>{uploadedSigData=e.target.result; document.getElementById('sigPreview').src=uploadedSigData; document.getElementById('sigPreview').style.display='block';};
        r.readAsDataURL(input.files[0]);
    }
}

// === 5. SUBMIT ===
async function submitApproval() {
    const status = document.getElementById('app_status').value;
    if(status === "Pending") return Swal.fire("Sila Pilih", "Sila pilih keputusan Lulus atau Tidak.", "warning");

    let finalSig = (currentSigMode === 'draw') ? canvas.toDataURL("image/png") : uploadedSigData;
    
    // Validation: Mesti ada tandatangan (optional)
    // if(!finalSig && !uploadedSigData) return Swal.fire("Tiada Tandatangan", "Sila tandatangan sebelum sahkan.", "warning");

    const result = await Swal.fire({
        title: 'Sahkan Keputusan?',
        text: `Anda pasti ingin ${status === "Approve" ? "MELULUSKAN" : "MENOLAK"} permohonan ini?`,
        icon: 'question', showCancelButton: true, confirmButtonColor: '#fbbf24', cancelButtonColor: '#334155', confirmButtonText: 'Ya, Sahkan', background: '#1e293b', color: '#fff'
    });

    if(result.isConfirmed) {
        try {
            Swal.fire({title:'Menyimpan...', didOpen:()=>{Swal.showLoading()}});
            
            // Simpan Data menggunakan camelCase standard
            await db.collection("complaint").doc(currentId).update({
                approvalStatus: status,
                approvalstatus: status, // Simpan dua-dua version just in case
                approverName: document.getElementById('app_name').value,
                approverPosition: document.getElementById('app_pos').value,
                approvalComment: document.getElementById('app_comment').value,
                approvalDate: firebase.firestore.FieldValue.serverTimestamp(),
                approverSignature: finalSig
            });
            
            await Swal.fire("Berjaya", "Keputusan telah direkodkan.", "success");
            showDashboard(); 
        } catch(e) { Swal.fire("Ralat", e.message, "error"); }
    }
}
</script>
