<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Approver Portal | TALK2YPKT</title>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&family=Orbitron:wght@500;700&display=swap');

    :root {
        --bg-dark: #0f172a;
        --card-bg: #1e293b;
        --gold: #fbbf24;
        --gold-glow: rgba(251, 191, 36, 0.3);
        --text: #f1f5f9;
        --text-muted: #94a3b8;
        --border: #334155;
        --green: #10b981;
        --red: #ef4444;
    }

    * { box-sizing: border-box; }
    body { 
        background: var(--bg-dark); 
        color: var(--text); 
        font-family: 'Poppins', sans-serif; 
        margin: 0; 
        min-height: 100vh; 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        padding: 20px;
    }

    .container { max-width: 900px; width: 100%; padding-bottom: 50px; align-self: flex-start; margin-top: 20px; }
    .hidden { display: none !important; }

    /* --- PIN SCREEN --- */
    #pinScreen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        background: rgba(15, 23, 42, 0.95); z-index: 999; backdrop-filter: blur(8px);
    }
    .pin-box {
        background: rgba(30, 41, 59, 0.7);
        padding: 50px 40px; border-radius: 20px;
        border: 1px solid var(--gold);
        box-shadow: 0 0 40px var(--gold-glow);
        text-align: center; width: 100%; max-width: 400px;
    }

    /* BARU: Container untuk input password dan mata */
    .password-wrapper {
        position: relative;
        width: 100%;
        margin: 25px 0;
    }

    .pin-input {
        width: 100%; padding: 15px; font-size: 18px; text-align: center; 
        letter-spacing: 2px;
        background: #020617; border: 2px solid #475569; color: var(--gold); 
        border-radius: 10px; 
        /* Margin dibuang di sini kerana dipindahkan ke wrapper */
        margin: 0; 
        outline: none; transition: 0.3s;
        padding-right: 45px; /* Ruang untuk ikon mata supaya teks tak bertindih */
    }
    .pin-input:focus { border-color: var(--gold); box-shadow: 0 0 15px var(--gold-glow); }

    /* BARU: Style untuk ikon mata */
    .toggle-password {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #64748b;
        cursor: pointer;
        z-index: 2;
        transition: color 0.3s;
    }
    .toggle-password:hover {
        color: var(--gold);
    }

    /* --- HEADER --- */
    .header { 
        display:flex; justify-content:space-between; align-items:center; 
        margin-bottom: 30px; padding-bottom:20px; border-bottom:1px solid var(--border); 
    }
    .header-left { display: flex; align-items: center; gap: 15px; }
    .header-title h1 { font-family: 'Orbitron'; color: #fff; margin: 0; font-size: 18px; letter-spacing: 1px; }
    .header-title span { font-size: 11px; color: var(--gold); letter-spacing: 2px; }
    
    .header-right { display: flex; align-items: center; gap: 10px; }

    .user-badge { 
        background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(251, 191, 36, 0.05));
        color: var(--gold); padding: 8px 15px; border-radius: 30px; 
        font-size: 12px; border: 1px solid var(--gold); font-weight: 600;
        display: flex; align-items: center; gap: 8px;
    }

    /* LOGOUT BUTTON STYLE */
    .btn-logout {
        background: rgba(239, 68, 68, 0.1);
        color: var(--red);
        border: 1px solid var(--red);
        padding: 8px 15px;
        border-radius: 30px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        display: flex; align-items: center; gap: 8px;
        transition: 0.3s;
    }
    .btn-logout:hover { background: var(--red); color: #fff; }

    /* --- LIST VIEW --- */
    .dashboard-title { font-family: 'Orbitron'; margin-bottom: 20px; color: #fff; font-size: 16px; display: flex; align-items: center; gap: 10px; }
    
    .pending-list { display: grid; gap: 15px; }
    
    .pending-card {
        background: var(--card-bg); padding: 25px; border-radius: 15px;
        border: 1px solid var(--border); cursor: pointer; transition: all 0.3s ease;
        display: flex; justify-content: space-between; align-items: center;
        position: relative; overflow: hidden;
    }
    .pending-card:hover { transform: translateY(-5px); border-color: var(--gold); box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
    .pending-card::before { content:''; position:absolute; left:0; top:0; bottom:0; width:5px; background:var(--gold); }
    
    .card-left { display: flex; align-items: center; gap: 20px; }
    .asset-icon { 
        width: 50px; height: 50px; background: rgba(255,255,255,0.05); border-radius: 12px; 
        display: flex; justify-content: center; align-items: center; color: var(--gold); font-size: 20px;
    }
    .card-info h3 { margin: 0 0 5px 0; color: #fff; font-size: 16px; font-weight: 600; }
    .card-info .meta { font-size: 12px; color: #94a3b8; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    
    .card-right { text-align: right; min-width: 80px;}
    .status-badge { background: rgba(16, 185, 129, 0.15); color: var(--green); padding: 5px 12px; border-radius: 6px; font-size: 10px; font-weight: 700; display: inline-block; margin-bottom: 5px; }

    /* --- FORM SECTION --- */
    .section-card { background: var(--card-bg); padding: 25px; border-radius: 12px; margin-bottom: 25px; border: 1px solid var(--border); position: relative; }
    .section-ribbon {
        position: absolute; top: 25px; left: 0; 
        background: var(--border); color: var(--gold); 
        padding: 5px 15px 5px 10px; font-family: 'Orbitron'; font-size: 11px; font-weight: bold;
        clip-path: polygon(0 0, 100% 0, 90% 100%, 0% 100%);
        box-shadow: 2px 2px 10px rgba(0,0,0,0.2);
    }
    .active-section { border: 1px solid var(--gold); box-shadow: 0 0 20px rgba(251, 191, 36, 0.1); }
    .active-section .section-ribbon { background: var(--gold); color: #000; }

    .grid-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 25px; }
    .full-width { grid-column: span 2; }
    
    .data-group label { font-size: 11px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 5px; }
    .data-value { 
        background: rgba(15, 23, 42, 0.6); padding: 12px; border-radius: 8px; 
        color: #e2e8f0; font-size: 13px; border: 1px solid #334155; min-height: 45px; display: flex; align-items: center; word-break: break-word;
    }
    .highlight { color: var(--gold); font-weight: 600; border-color: rgba(251, 191, 36, 0.3); }

    /* INPUTS & BUTTONS */
    input, select, textarea { width: 100%; padding: 12px; background: #020617; border: 1px solid var(--gold); color: #fff; border-radius: 8px; outline: none; font-family: 'Poppins'; font-size: 14px; }
    .btn-submit { 
        width: 100%; padding: 16px; background: var(--gold); border: none; border-radius: 10px; 
        font-weight: 700; cursor: pointer; font-family: 'Orbitron'; color: #0f172a; font-size: 16px; margin-top: 10px; 
        transition: 0.3s; text-transform: uppercase; letter-spacing: 1px;
    }
    .btn-submit:hover { background: #fcd34d; transform: scale(1.02); }
    .btn-back { background: transparent; color: var(--text-muted); border: none; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 14px; margin-bottom: 20px; transition: 0.3s; }
    .btn-back:hover { color: #fff; transform: translateX(-5px); }

    /* SIGNATURE */
    .sig-tabs { display: flex; gap: 5px; margin-bottom: 10px; background: #0f172a; padding: 5px; border-radius: 8px; }
    .tab-btn { flex: 1; padding: 8px; background: transparent; border: none; color: #64748b; cursor: pointer; border-radius: 5px; font-size: 12px; font-weight: 600; transition: 0.3s; }
    .tab-btn.active { background: var(--gold); color: #000; }
    canvas { background: #fff; width: 100%; height: 160px; border-radius: 8px; cursor: crosshair; }

    @media (max-width: 600px) { 
        .grid-container { grid-template-columns: 1fr; } 
        .full-width { grid-column: span 1; }
        .pin-box { margin: 20px; }
        .header { flex-direction: column; align-items: flex-start; gap: 15px; } /* Adjust header mobile */
        .header-right { width: 100%; justify-content: space-between; }
    }
</style>
</head>
<body>

<div id="pinScreen">
    <div class="pin-box">
        <img src="Asset/Logo-Yayasan-Pembangunan-Keluarga-Terengganu (1).png" width="90" style="margin-bottom:20px;">
        <h2 style="color:var(--gold); font-family:'Orbitron'; margin:0;">EXECUTIVE ACCESS</h2>
        <p style="color:#64748b; font-size:12px; margin-top:5px;">PLEASE ENTER SECURITY PASSWORD</p>
        
        <div class="password-wrapper">
            <input type="password" id="secretPin" class="pin-input" placeholder="Enter Password">
            <i class="fa-solid fa-eye" id="toggleIcon" onclick="togglePasswordVisibility()" class="toggle-password" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #64748b; cursor: pointer;"></i>
        </div>
        
        <button onclick="checkPin()" class="btn-submit" style="margin-top:10px;">
            <i class="fa-solid fa-lock-open"></i> SIGN IN
        </button>
    </div>
</div>

<div id="mainApp" class="container hidden">
    
    <div class="header">
        <div class="header-left">
            <img src="Asset/Logo-Yayasan-Pembangunan-Keluarga-Terengganu (1).png" width="45">
            <div class="header-title">
                <h1>APPROVAL DASHBOARD</h1>
                <span>YAYASAN PEMBANGUNAN KELUARGA TERENGGANU</span>
            </div>
        </div>
        
        <div class="header-right">
            <div class="user-badge">
                <i class="fa-solid fa-user-tie"></i> DEPUTY DIRECTOR
            </div>
            <button class="btn-logout" onclick="logoutApp()">
                <i class="fa-solid fa-power-off"></i> SIGN OUT
            </button>
        </div>
    </div>

    <div id="dashboardView">
        <div class="dashboard-title">
            <i class="fa-solid fa-clipboard-list" style="color:var(--gold)"></i> APPROVAL WAITING LIST
        </div>
        
        <div id="loadingMsg" style="text-align:center; color:#64748b; padding:40px; border:1px dashed #334155; border-radius:10px;">
            <i class="fa-solid fa-circle-notch fa-spin"></i> Checking the Database...
        </div>
        
        <div id="pendingList" class="pending-list">
        </div>
    </div>

    <div id="approvalForm" class="hidden">
        
        <button class="btn-back" onclick="showDashboard()">
            <i class="fa-solid fa-arrow-left"></i> BACK TO LIST
        </button>

        <div class="section-card">
            <div class="section-ribbon">SEC 1: DETAILS OF ASSETS & COMPLAINANTS</div>
            <div class="grid-container">
                <div class="data-group"><label>Complainant's Name (Last User)</label><div class="data-value highlight" id="v_lastUser"></div></div>
                <div class="data-group"><label>Damage Date</label><div class="data-value" id="v_damagedate"></div></div>
                <div class="data-group"><label>Asset Type</label><div class="data-value" id="v_assettype"></div></div>
                <div class="data-group"><label>Serial Number</label><div class="data-value" id="v_serialNumber"></div></div>
                <div class="data-group full-width"><label>Description of Damage</label><div class="data-value" id="v_damagedescription"></div></div>
            </div>
        </div>

        <div class="section-card">
            <div class="section-ribbon">SEC 2: ASSET OFFICER AREA OFFICER</div>
            <div class="grid-container">
                <div class="data-group"><label>Officer Name</label><div class="data-value" id="v_section2nameposition"></div></div>
                <div class="data-group"><label>Inspection Date</label><div class="data-value" id="v_section2date"></div></div>
                <div class="data-group full-width"><label>Reviews / Recommendations</label><div class="data-value" id="v_recommendationsection2"></div></div>
            </div>
        </div>

        <div class="section-card">
            <div class="section-ribbon">SEC 3: TECHNICAL REVIEW</div>
            <div class="grid-container">
                <div class="data-group"><label>Technical Officer</label><div class="data-value" id="v_section3nameposition"></div></div>
                <div class="data-group"><label>Review Date</label><div class="data-value" id="v_section3date"></div></div>
                
                <div class="data-group"><label>Previous Cost</label><div class="data-value" id="v_previousmaintenancecost"></div></div>
                <div class="data-group"><label>Cost Estimate</label><div class="data-value highlight" style="color:var(--green);" id="v_estimatedmaintenancecost"></div></div>
                
                <div class="data-group full-width"><label>Technical Recommendations</label><div class="data-value" id="v_recommendsection3"></div></div>
            </div>
        </div>

        <div class="section-card active-section">
            <div class="section-ribbon">SEC 4: DIRECTOR'S APPROVAL</div>
            <div class="grid-container">
                <div class="full-width">
                    <label style="color:var(--gold);">DECISION <span style="color:var(--red)">*</span></label>
                    <select id="app_status" style="font-size:16px; font-weight:bold;">
                        <option value="Pending">-- PLEASE CHOOSE A RESULT --</option>
                        <option value="Approve">✅ APPROVE</option>
                        <option value="Reject">❌ REJECT</option>
                    </select>
                </div>
                
                <div class="data-group"><label>NAME <span style="color:var(--red)">*</span></label><input type="text" id="app_name" placeholder="Nama Penuh"></div>
                <div class="data-group"><label>POSITION <span style="color:var(--red)">*</span></label><input type="text" id="app_pos" placeholder="Jawatan"></div>
                
                <div class="full-width">
                    <label>Comments / Notes</label>
                    <textarea id="app_comment" rows="3" placeholder="Please enter a comment if you have any..."></textarea>
                </div>

                <div class="full-width" style="margin-top:15px; border-top:1px solid #334155; padding-top:15px;">
                    <label style="color:var(--gold); display:flex; justify-content:space-between;">
                        <span>SIGNATURE <span style="color:var(--red)">*</span></span>
                        <span style="font-size:10px; cursor:pointer; color:#ef4444;" onclick="clearSignature()"><i class="fa fa-trash"></i> DELETE</span>
                    </label>
                    
                    <div class="sig-tabs">
                        <button class="tab-btn active" id="btnDraw" onclick="switchSigMode('draw')">DRAW ON THE SCREEN</button>
                        <button class="tab-btn" id="btnUpload" onclick="switchSigMode('upload')">UPLOAD SIGNATURE</button>
                    </div>
                    
                    <div id="areaDraw">
                        <canvas id="sigCanvas"></canvas>
                    </div>
                    
                    <div id="areaUpload" class="hidden">
                        <div style="padding:30px; border:2px dashed #475569; text-align:center; border-radius:8px;">
                            <input type="file" id="sigFile" accept="image/*" onchange="previewSig(this)" style="color:#fff;">
                            <img id="sigPreview" style="max-height:100px; display:none; margin:15px auto; border:1px solid #fff;">
                        </div>
                    </div>
                </div>
            </div>

            <button class="btn-submit" onclick="submitApproval()">
                <i class="fa-solid fa-file-signature"></i> CONFIRM THE DECISION
            </button>
        </div>
    </div>
</div>

<script>
// --- CONFIGURATION ---
const firebaseConfig={
  apiKey:"AIzaSyDjsNiteoay79tpavm_dfCcKHhRvBfU0Tk",
  authDomain:"e-complaint-8nu9kp.firebaseapp.com",
  projectId:"e-complaint-8nu9kp"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();
const auth=firebase.auth();

// === BARU: FUNGSI TOGGLE PASSWORD ===
function togglePasswordVisibility() {
    const input = document.getElementById('secretPin');
    const icon = document.getElementById('toggleIcon');
    
    if (input.type === "password") {
        input.type = "text";
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
        icon.style.color = "#fbbf24"; // Tukar warna ke Emas bila nampak
    } else {
        input.type = "password";
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
        icon.style.color = "#64748b"; // Warna asal
    }
}

// === 1. LOGIN SYSTEM (UPDATED STRONG PASSWORD) ===
function checkPin() {
    const pin = document.getElementById('secretPin').value;
    const btn = document.querySelector('.pin-box button');
    
    // Password: Ypkt@2026
    const strongPassword = "Ypkt@2026"; 

    if(pin === strongPassword) { 
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> VERIFYING...';
        auth.signInWithEmailAndPassword("timbalanpengarah@ypkt.gov.my", "ypkt0101").then(() => {
            document.getElementById('pinScreen').style.display = 'none'; 
            document.getElementById('mainApp').classList.remove('hidden'); 
            loadPendingList();
            setupCanvas();
        }).catch(e => {
            btn.innerHTML = '<i class="fa-solid fa-lock-open"></i> SIGN IN';
            Swal.fire("Login Error", "System failed to log in.", "error");
        });
    } else {
        Swal.fire({
            icon: 'error', 
            title: 'Akses Ditolak', 
            text: 'Password salah. Sila masukkan password yang sah.', 
            background: '#1e293b', 
            color: '#fff'
        });
        document.getElementById('secretPin').value = "";
    }
}

// === LOGOUT SYSTEM ===
function logoutApp() {
    Swal.fire({
        title: 'Log out?',
        text: "You will definitely want to log out?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#334155',
        confirmButtonText: 'Yes, sign out',
        background: '#1e293b',
        color: '#fff'
    }).then((result) => {
        if (result.isConfirmed) {
            auth.signOut().then(() => {
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('approvalForm').classList.add('hidden');
                document.getElementById('dashboardView').classList.remove('hidden');
                document.getElementById('pinScreen').style.display = 'flex';
                document.getElementById('secretPin').value = "";
                // Reset toggle icon
                const input = document.getElementById('secretPin');
                const icon = document.getElementById('toggleIcon');
                input.type = "password";
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
                
                document.querySelector('.pin-box button').innerHTML = '<i class="fa-solid fa-lock-open"></i> SIGN IN';
            });
        }
    });
}

// === 2. LOAD LIST ===
function loadPendingList() {
    const container = document.getElementById('pendingList');
    const msg = document.getElementById('loadingMsg');
    
    db.collection("complaint").onSnapshot((snapshot) => {
        let html = "";
        let count = 0;

        snapshot.forEach(doc => {
            const d = doc.data();
            const status = d.approvalstatus || "Pending"; 
            const statusLower = status.toLowerCase().trim();
            const isNotDecided = (statusLower !== "approve" && statusLower !== "reject");
            const isTechDone = (d.section3date != null); 

            if(isNotDecided && isTechDone) {
                count++;
                const type = d.assettype || "Umum"; 
                const name = d.lastUser || "Tanpa Nama"; 
                const dateVal = d.damagedate;

                let icon = "fa-box";
                if(type.toLowerCase().includes("komputer") || type.toLowerCase().includes("laptop")) icon = "fa-computer";
                if(type.toLowerCase().includes("pencetak") || type.toLowerCase().includes("printer")) icon = "fa-print";
                
                html += `
                <div class="pending-card" onclick="openDetail('${doc.id}')">
                    <div class="card-left">
                        <div class="asset-icon"><i class="fa-solid ${icon}"></i></div>
                        <div class="card-info">
                            <h3>${type}</h3>
                            <div class="meta">
                                <span><i class="fa-solid fa-user"></i> ${name}</span>
                                <span><i class="fa-solid fa-calendar"></i> ${formatDate(dateVal)}</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-right">
                        <div class="status-badge">READY</div>
                        <div><i class="fa-solid fa-arrow-right" style="color:var(--gold)"></i></div>
                    </div>
                </div>`;
            }
        });

        if(count === 0) {
            msg.innerHTML = "No applications are pending approval.";
            msg.style.display = 'block';
            container.innerHTML = "";
        } else {
            msg.style.display = 'none';
            container.innerHTML = html;
        }
    });
}

// === 3. OPEN DETAIL ===
let currentId = "";

async function openDetail(id) {
    currentId = id;
    Swal.fire({title:'Mengambil Data...', didOpen:()=>{Swal.showLoading()}});
    
    try {
        const doc = await db.collection("complaint").doc(id).get();
        const d = doc.data();
        Swal.close();

        document.getElementById('dashboardView').classList.add('hidden');
        document.getElementById('approvalForm').classList.remove('hidden');

        // SEC 1
        setText('v_lastUser', d.lastUser || "-"); 
        setText('v_damagedate', formatDate(d.damagedate)); 
        setText('v_assettype', d.assettype || "-");
        setText('v_serialNumber', d.serialNumber || "-");
        setText('v_damagedescription', d.damagedescription || "-");

        // SEC 2
        setText('v_section2nameposition', d.section2nameposition || "-");
        setText('v_section2date', formatDate(d.section2date));
        setText('v_recommendationsection2', d.recommendationsection2 || "-");

        // SEC 3
        setText('v_section3nameposition', d.section3nameposition || "-");
        setText('v_section3date', formatDate(d.section3date));
        let prevCost = d.previousmaintenancecost || "0";
        setText('v_previousmaintenancecost', "RM " + prevCost);
        let estCost = d.estimatedmaintenancecost || "0";
        setText('v_estimatedmaintenancecost', "RM " + estCost);
        setText('v_recommendsection3', d.recommendsection3 || "-");

        // SEC 4
        document.getElementById('app_name').value = d.approvername || "ENCIK ASHRI";
        document.getElementById('app_pos').value = d.approverposition || "TIMBALAN PENGARAH";
        document.getElementById('app_comment').value = d.approvalcomment || "";
        document.getElementById('app_status').value = d.approvalstatus || "Pending";

        clearSignature();
        setTimeout(setupCanvas, 300);

    } catch(e) {
        Swal.fire("Ralat", "Gagal data: " + e.message, "error");
    }
}

function setText(id, val) { 
    const el = document.getElementById(id); 
    if(el) el.innerText = val; 
}

function formatDate(timestamp) {
    if(!timestamp) return "-";
    let dateObj = timestamp;
    if(timestamp.toDate) dateObj = timestamp.toDate();
    try { return new Date(dateObj).toLocaleDateString('en-GB'); } catch(e) { return timestamp; }
}

function showDashboard() {
    document.getElementById('approvalForm').classList.add('hidden');
    document.getElementById('dashboardView').classList.remove('hidden');
    loadPendingList(); 
}

// === 4. SIGNATURE ===
let currentSigMode = 'draw';
let canvas, ctx, isDrawing=false, uploadedSigData=null;

function switchSigMode(mode) {
    currentSigMode = mode;
    document.getElementById('btnDraw').className = mode === 'draw' ? 'tab-btn active' : 'tab-btn';
    document.getElementById('btnUpload').className = mode === 'upload' ? 'tab-btn active' : 'tab-btn';
    if(mode === 'draw') {
        document.getElementById('areaDraw').classList.remove('hidden');
        document.getElementById('areaUpload').classList.add('hidden');
        setupCanvas();
    } else {
        document.getElementById('areaDraw').classList.add('hidden');
        document.getElementById('areaUpload').classList.remove('hidden');
    }
}
function setupCanvas(){
    canvas=document.getElementById('sigCanvas'); if(!canvas) return;
    ctx=canvas.getContext('2d');
    const rect = canvas.parentElement.getBoundingClientRect();
    canvas.width = rect.width; canvas.height = 160;
    ctx.lineWidth=3; ctx.lineJoin='round'; ctx.lineCap='round'; ctx.strokeStyle='#000';
    canvas.onmousedown=start; canvas.onmousemove=draw; canvas.onmouseup=end; canvas.onmouseleave=end;
    canvas.ontouchstart=(e)=>{e.preventDefault();start(e.touches[0])};
    canvas.ontouchmove=(e)=>{e.preventDefault();draw(e.touches[0])};
    canvas.ontouchend=end;
}
function start(e){isDrawing=true; ctx.beginPath(); ctx.moveTo(e.clientX-canvas.getBoundingClientRect().left, e.clientY-canvas.getBoundingClientRect().top);}
function draw(e){if(!isDrawing)return; ctx.lineTo(e.clientX-canvas.getBoundingClientRect().left, e.clientY-canvas.getBoundingClientRect().top); ctx.stroke();}
function end(){isDrawing=false;}
function clearSignature(){ if(ctx) ctx.clearRect(0,0,canvas.width,canvas.height); uploadedSigData=null; document.getElementById('sigFile').value=""; document.getElementById('sigPreview').style.display='none';}
function previewSig(input){
    if(input.files[0]){
        const r=new FileReader();
        r.onload=(e)=>{uploadedSigData=e.target.result; document.getElementById('sigPreview').src=uploadedSigData; document.getElementById('sigPreview').style.display='block';};
        r.readAsDataURL(input.files[0]);
    }
}

// === 5. SUBMIT (Save to Database) - WITH VALIDATION ===
async function submitApproval() {
    // 1. Get Values
    const status = document.getElementById('app_status').value;
    const name = document.getElementById('app_name').value.trim();
    const position = document.getElementById('app_pos').value.trim();
    
    // 2. Validate Decision
    if(status === "Pending") {
        return Swal.fire("Required Field", "Please select a DECISION (Approve/Reject).", "warning");
    }

    // 3. Validate Name
    if(name === "") {
        return Swal.fire("Required Field", "Please enter the NAME.", "warning");
    }

    // 4. Validate Position
    if(position === "") {
        return Swal.fire("Required Field", "Please enter the POSITION.", "warning");
    }

    // 5. Validate Signature
    let finalSig = null;
    if(currentSigMode === 'draw') {
        // Create blank canvas for comparison
        const blank = document.createElement('canvas');
        blank.width = canvas.width;
        blank.height = canvas.height;
        if(canvas.toDataURL() === blank.toDataURL()) {
            return Swal.fire("Required Field", "Please DRAW your signature.", "warning");
        }
        finalSig = canvas.toDataURL("image/png");
    } else {
        // Upload check
        if(!uploadedSigData) {
            return Swal.fire("Required Field", "Please UPLOAD your signature.", "warning");
        }
        finalSig = uploadedSigData;
    }

    const result = await Swal.fire({
        title: 'Confirm Results?',
        text: `You definitely want to ${status === "Approve" ? "APPROVE" : "REJECT"} this application?`,
        icon: 'question', showCancelButton: true, confirmButtonColor: '#fbbf24', cancelButtonColor: '#334155', confirmButtonText: 'Yes, Confirm', background: '#1e293b', color: '#fff'
    });

    if(result.isConfirmed) {
        try {
            Swal.fire({title:'Menyimpan...', didOpen:()=>{Swal.showLoading()}});
            
            await db.collection("complaint").doc(currentId).update({
                approvalstatus: status, 
                approvername: name,
                approverposition: position,
                approvalcomment: document.getElementById('app_comment').value,
                approvaldate: firebase.firestore.FieldValue.serverTimestamp(),
                approverSignature: finalSig
            });
            
            await Swal.fire("Successful", "The results have been recorded.", "success");
            showDashboard(); 
        } catch(e) { Swal.fire("Ralat", e.message, "error"); }
    }
}
</script>
</body>
</html>
