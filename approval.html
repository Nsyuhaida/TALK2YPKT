<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Approver Portal | TALK2YPKT</title>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Orbitron:wght@500;700&display=swap');

    :root {
        --bg-dark: #0f172a;
        --card-bg: #1e293b;
        --gold: #fbbf24;
        --text: #e2e8f0;
        --border: #334155;
    }

    body { background: var(--bg-dark); color: var(--text); font-family: 'Poppins', sans-serif; padding: 20px; display: flex; justify-content: center; min-height: 100vh; }

    .container { max-width: 850px; width: 100%; margin: 0 auto; padding-bottom: 50px; }
    .hidden { display: none !important; }

    /* --- PIN SCREEN --- */
    #pinScreen {
        max-width: 400px; margin: 80px auto; text-align: center;
        background: var(--card-bg); padding: 40px; border-radius: 15px;
        border: 1px solid var(--gold); box-shadow: 0 0 20px rgba(251, 191, 36, 0.2);
    }
    .pin-input {
        width: 100%; padding: 15px; font-size: 24px; text-align: center; letter-spacing: 10px;
        background: #0f172a; border: 1px solid #475569; color: var(--gold); border-radius: 8px; margin: 20px 0;
    }

    /* --- HEADER --- */
    .header { text-align: center; margin-bottom: 30px; }
    .header img { width: 80px; margin-bottom: 10px; }
    .header h1 { font-family: 'Orbitron'; color: var(--gold); margin: 0; font-size: 22px; }
    
    /* --- SEARCH --- */
    .search-box {
        background: var(--card-bg); padding: 20px; border-radius: 15px;
        text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        border: 1px solid rgba(251, 191, 36, 0.3); margin-bottom: 30px;
    }
    .input-code {
        width: 60%; padding: 12px; font-size: 16px; border-radius: 8px;
        border: 1px solid #475569; background: #0f172a; color: #fff;
        text-align: center; letter-spacing: 1px;
    }
    .btn-find {
        padding: 12px 25px; background: var(--gold); color: #000; font-weight: bold;
        border: none; border-radius: 8px; cursor: pointer; font-size: 14px; margin-left: 10px;
    }

    /* --- CARDS --- */
    .section-card {
        background: var(--card-bg); padding: 20px; border-radius: 10px; margin-bottom: 20px;
        border: 1px solid var(--border);
    }
    .section-header {
        background: rgba(255,255,255,0.05); padding: 8px 15px; border-radius: 5px;
        margin-bottom: 15px; border-left: 4px solid #64748b;
        font-family: 'Orbitron'; font-size: 13px; color: #94a3b8; font-weight: bold; letter-spacing: 1px;
    }
    .active-section { border-color: var(--gold); box-shadow: 0 0 15px rgba(251, 191, 36, 0.1); }
    .active-section .section-header { border-left-color: var(--gold); color: var(--gold); background: rgba(251, 191, 36, 0.1); }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .full { grid-column: span 2; }

    label { font-size: 11px; color: #64748b; display: block; margin-bottom: 4px; text-transform: uppercase; }
    .field-val { 
        background: #0f172a; padding: 10px; border-radius: 6px; 
        color: #e2e8f0; font-size: 13px; border: 1px solid #334155; min-height: 20px;
    }

    input, select, textarea {
        width: 100%; padding: 10px; background: #020617; border: 1px solid var(--gold);
        color: #fff; border-radius: 6px; outline: none; box-sizing: border-box; font-family: 'Poppins', sans-serif;
    }

    /* --- SIGNATURE DUAL MODE --- */
    .sig-tabs { display: flex; gap: 10px; margin-bottom: 10px; }
    .tab-btn {
        flex: 1; padding: 10px; background: #334155; border: none; color: #fff;
        cursor: pointer; border-radius: 5px; font-size: 12px;
    }
    .tab-btn.active { background: var(--gold); color: #000; font-weight: bold; }

    .sig-area {
        background: #fff; border-radius: 8px; padding: 10px; text-align: center;
        border: 2px dashed #475569; min-height: 160px; display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
    
    /* Draw Mode */
    canvas { border: 1px solid #ccc; cursor: crosshair; touch-action: none; width: 100%; height: 150px; }
    
    /* Upload Mode */
    .upload-box { width: 100%; }
    .preview-img { max-height: 100px; margin-top: 10px; display: none; border: 1px solid #ccc; }

    /* ACTION BUTTONS */
    .btn-submit {
        width: 100%; padding: 15px; background: var(--gold); border: none; border-radius: 8px;
        font-weight: bold; cursor: pointer; font-family: 'Orbitron'; color: #000; font-size: 16px; margin-top: 20px;
        transition: transform 0.2s;
    }
    .btn-submit:active { transform: scale(0.98); }

</style>
</head>
<body>

<div id="pinScreen">
    <img src="Asset/Logo-Yayasan-Pembangunan-Keluarga-Terengganu (1).png" width="80" style="margin-bottom:20px;">
    <h2 style="color:var(--gold); font-family:'Orbitron'">EXECUTIVE ACCESS</h2>
    <input type="password" id="secretPin" class="pin-input" placeholder="****" maxlength="4">
    <button onclick="checkPin()" class="btn-submit" style="margin-top:0;">ACCESS PORTAL</button>
</div>

<div id="mainApp" class="container hidden">
    <div class="header">
        <img src="Asset/Logo-Yayasan-Pembangunan-Keluarga-Terengganu (1).png" alt="Logo">
        <h1>APPROVAL DASHBOARD</h1>
        <p style="color:#64748b; font-size:12px;">Logged in as: Timbalan Pengarah</p>
    </div>

    <div class="search-box">
        <input type="text" id="searchId" class="input-code" placeholder="Enter Reference ID">
        <button class="btn-find" onclick="findComplaint()"><i class="fa-solid fa-magnifying-glass"></i> FIND</button>
    </div>

    <div id="approvalForm" class="hidden">
        
        <div class="section-card">
            <div class="section-header">SEC 1: INFO ASET & PENGADU</div>
            <div class="grid">
                <div><label>Asset Type</label><div class="field-val" id="v_assettype"></div></div>
                <div><label>Serial Number</label><div class="field-val" id="v_serialNumber"></div></div>
                <div><label>Last User</label><div class="field-val" id="v_lastUser"></div></div>
                <div><label>Damage Date</label><div class="field-val" id="v_damagedate"></div></div>
                <div class="full"><label>Damage Description</label><div class="field-val" id="v_damagedescription"></div></div>
                <div><label>Reporter Name/Pos</label><div class="field-val" id="v_reporternamaposition"></div></div>
                <div><label>Report Date</label><div class="field-val" id="v_reportdatesection1"></div></div>
            </div>
        </div>

        <div class="section-card">
            <div class="section-header">SEC 2: SYOR PEGAWAI KAWASAN</div>
            <div class="grid">
                <div><label>Officer Name/Pos</label><div class="field-val" id="v_section2nameposition"></div></div>
                <div><label>Recommendation Date</label><div class="field-val" id="v_section2date"></div></div>
                <div class="full"><label>Recommendation</label><div class="field-val" id="v_recommendationsection2"></div></div>
            </div>
        </div>

        <div class="section-card">
            <div class="section-header">SEC 3: ULASAN TEKNIKAL (IT)</div>
            <div class="grid">
                <div><label>IT Officer Name/Pos</label><div class="field-val" id="v_section3nameposition"></div></div>
                <div><label>Verification Date</label><div class="field-val" id="v_section3date"></div></div>
                <div><label>Prev. Maint. Cost (RM)</label><div class="field-val" id="v_previousmaintenancecost"></div></div>
                <div><label>Est. Maint. Cost (RM)</label><div class="field-val" id="v_estimatedmaintenancecost"></div></div>
                <div class="full"><label>Technical Recommendation</label><div class="field-val" id="v_recommendsection3"></div></div>
            </div>
        </div>

        <div class="section-card active-section">
            <div class="section-header"><i class="fa-solid fa-pen-nib"></i> SEC 4: APPROVAL ACTION</div>
            
            <div class="grid">
                <div class="full">
                    <label style="color:var(--gold);">Approval Status</label>
                    <select id="app_status" style="font-size:16px;">
                        <option value="Pending">-- Select Decision --</option>
                        <option value="Approve">LULUS (APPROVE)</option>
                        <option value="Reject">TIDAK LULUS (REJECT)</option>
                    </select>
                </div>
                <div>
                    <label>Approver Name</label>
                    <input type="text" id="app_name" value="ENCIK ASHRI">
                </div>
                <div>
                    <label>Approver Position</label>
                    <input type="text" id="app_pos" value="TIMBALAN PENGARAH">
                </div>
                <div class="full">
                    <label>Approval Comment</label>
                    <textarea id="app_comment" rows="2" placeholder="Catatan tambahan..."></textarea>
                </div>

                <div class="full" style="margin-top:10px;">
                    <label style="color:var(--gold);">TANDATANGAN DIGITAL / COP</label>
                    
                    <div class="sig-tabs">
                        <button class="tab-btn active" id="btnDraw" onclick="switchSigMode('draw')">
                            <i class="fa-solid fa-pen"></i> LUKIS (DRAW)
                        </button>
                        <button class="tab-btn" id="btnUpload" onclick="switchSigMode('upload')">
                            <i class="fa-solid fa-upload"></i> UPLOAD COP/IMEJ
                        </button>
                    </div>

                    <div id="areaDraw" class="sig-area">
                        <canvas id="sigCanvas"></canvas>
                        <div style="width:100%; text-align:right; margin-top:5px;">
                            <button onclick="clearSignature()" style="background:#ef4444; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:11px;">Clear Pad</button>
                        </div>
                    </div>

                    <div id="areaUpload" class="sig-area hidden">
                        <div class="upload-box">
                            <input type="file" id="sigFile" accept="image/*" onchange="previewSig(this)" style="background:none; border:none; color:#000;">
                            <br>
                            <img id="sigPreview" class="preview-img" src="">
                            <p style="color:#555; font-size:11px; margin-top:5px;">Format: JPG/PNG (Max 1MB)</p>
                        </div>
                    </div>

                </div>
            </div>

            <button class="btn-submit" onclick="submitApproval()">
                <i class="fa-solid fa-check-circle"></i> SUBMIT APPROVAL
            </button>
        </div>

    </div>
</div>

<script>
// --- FIREBASE SETUP ---
const firebaseConfig={
  apiKey:"AIzaSyDjsNiteoay79tpavm_dfCcKHhRvBfU0Tk",
  authDomain:"e-complaint-8nu9kp.firebaseapp.com",
  projectId:"e-complaint-8nu9kp"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();
const auth=firebase.auth();

// === 1. GHOST LOGIN ===
function checkPin() {
    const pin = document.getElementById('secretPin').value;
    const btn = document.querySelector('#pinScreen button');
    
    if(pin === "1234") { 
        btn.innerHTML = "Authenticating...";
        auth.signInWithEmailAndPassword("timbalanpengarah@ypkt.gov.my", "ypkt0101")
        .then(() => {
            document.getElementById('pinScreen').classList.add('hidden'); 
            document.getElementById('mainApp').classList.remove('hidden'); 
            setupCanvas();
        })
        .catch((error) => {
            btn.innerHTML = "ACCESS PORTAL";
            Swal.fire("Login Failed", error.message, "error");
        });
    } else {
        Swal.fire("Akses Ditolak", "PIN Salah!", "error");
        document.getElementById('secretPin').value = "";
    }
}

// === 2. SIGNATURE LOGIC (DUAL MODE) ===
let currentSigMode = 'draw';
let canvas, ctx, isDrawing = false;
let uploadedSigData = null; // Store base64 from upload

function switchSigMode(mode) {
    currentSigMode = mode;
    // UI Updates
    document.getElementById('btnDraw').className = mode === 'draw' ? 'tab-btn active' : 'tab-btn';
    document.getElementById('btnUpload').className = mode === 'upload' ? 'tab-btn active' : 'tab-btn';
    
    // Area Visibility
    if(mode === 'draw') {
        document.getElementById('areaDraw').classList.remove('hidden');
        document.getElementById('areaUpload').classList.add('hidden');
        setupCanvas(); // Resize fix
    } else {
        document.getElementById('areaDraw').classList.add('hidden');
        document.getElementById('areaUpload').classList.remove('hidden');
    }
}

function setupCanvas() {
    canvas = document.getElementById('sigCanvas');
    ctx = canvas.getContext('2d');
    canvas.width = canvas.offsetWidth; 
    canvas.height = 150;
    ctx.lineWidth = 3; ctx.lineJoin = 'round'; ctx.lineCap = 'round'; ctx.strokeStyle = '#000';

    // Events
    canvas.onmousedown = startDraw; canvas.onmousemove = draw; canvas.onmouseup = endDraw; canvas.onmouseout = endDraw;
    canvas.ontouchstart = (e)=>{e.preventDefault(); startDraw(e.touches[0])};
    canvas.ontouchmove = (e)=>{e.preventDefault(); draw(e.touches[0])};
    canvas.ontouchend = endDraw;
}
function startDraw(e){ isDrawing=true; ctx.beginPath(); ctx.moveTo(e.clientX-canvas.getBoundingClientRect().left, e.clientY-canvas.getBoundingClientRect().top); }
function draw(e){ if(!isDrawing)return; ctx.lineTo(e.clientX-canvas.getBoundingClientRect().left, e.clientY-canvas.getBoundingClientRect().top); ctx.stroke(); }
function endDraw(){ isDrawing=false; }
function clearSignature(){ ctx.clearRect(0,0,canvas.width,canvas.height); }

function previewSig(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('sigPreview').src = e.target.result;
            document.getElementById('sigPreview').style.display = "block";
            uploadedSigData = e.target.result; // Keep Base64
        }
        reader.readAsDataURL(input.files[0]);
    }
}

// === 3. DATA FETCHING ===
const dt = (t) => t && t.toDate ? t.toDate().toLocaleDateString("en-GB") : "-";
let currentId = "";

async function findComplaint() {
    const id = document.getElementById('searchId').value.trim();
    if(!id) return Swal.fire("Input Error", "Please enter ID", "warning");

    try {
        const doc = await db.collection("complaint").doc(id).get();
        if(doc.exists) {
            const d = doc.data();
            currentId = id;

            // SECTION 1
            document.getElementById('v_assettype').innerText = d.assettype || "-";
            document.getElementById('v_serialNumber').innerText = d.serialNumber || "-";
            document.getElementById('v_lastUser').innerText = d.lastUser || "-";
            document.getElementById('v_damagedate').innerText = dt(d.damagedate);
            document.getElementById('v_damagedescription').innerText = d.damagedescription || "-";
            document.getElementById('v_reporternamaposition').innerText = d.reporternamaposition || "-";
            document.getElementById('v_reportdatesection1').innerText = dt(d.reportdatesection1);

            // SECTION 2
            document.getElementById('v_section2nameposition').innerText = d.section2nameposition || "-";
            document.getElementById('v_section2date').innerText = dt(d.section2date);
            document.getElementById('v_recommendationsection2').innerText = d.recommendationsection2 || "-";

            // SECTION 3
            document.getElementById('v_section3nameposition').innerText = d.section3nameposition || "-";
            document.getElementById('v_section3date').innerText = dt(d.section3date || d.section3Date);
            document.getElementById('v_previousmaintenancecost').innerText = d.previousmaintenancecost || "0.00";
            document.getElementById('v_estimatedmaintenancecost').innerText = d.estimatedmaintenancecost || "0.00";
            document.getElementById('v_recommendsection3').innerText = d.recommendsection3 || "-";

            // SECTION 4 (PRE-FILL)
            document.getElementById('app_status').value = d.approvalstatus || "Pending";
            document.getElementById('app_name').value = d.approvername || "ENCIK ASHRI";
            document.getElementById('app_pos').value = d.approverposition || "TIMBALAN PENGARAH";
            document.getElementById('app_comment').value = d.approvalcomment || "";

            // Show Form
            document.getElementById('approvalForm').classList.remove('hidden');
            setTimeout(setupCanvas, 500); // Reset canvas size

        } else {
            Swal.fire("Not Found", "Reference ID not found in database.", "error");
            document.getElementById('approvalForm').classList.add('hidden');
        }
    } catch(e) {
        console.error(e);
        Swal.fire("Error", "Connection error.", "error");
    }
}

// === 4. SUBMIT FUNCTION ===
async function submitApproval() {
    if(!currentId) return;

    const status = document.getElementById('app_status').value;
    if(status === "Pending") return Swal.fire("Required", "Sila pilih Status (Lulus/Tidak).", "warning");

    // DETERMINE FINAL SIGNATURE
    let finalSignature = "";
    
    if (currentSigMode === 'draw') {
        // Check if canvas is empty (basic check)
        const blank = document.createElement('canvas');
        blank.width = canvas.width; blank.height = canvas.height;
        if(canvas.toDataURL() === blank.toDataURL()) {
            // Optional: Allow empty signature? Maybe not.
            // return Swal.fire("Signature Required", "Sila tandatangan.", "warning");
        }
        finalSignature = canvas.toDataURL("image/png");
    } else {
        // Upload Mode
        if(!uploadedSigData) {
            // return Swal.fire("Upload Required", "Sila upload gambar cop/tandatangan.", "warning");
        }
        finalSignature = uploadedSigData;
    }

    // CONFIRM
    const result = await Swal.fire({
        title: 'Sahkan Keputusan?',
        text: `Status: ${status}`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#fbbf24',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Ya, Submit!'
    });

    if (result.isConfirmed) {
        try {
            await db.collection("complaint").doc(currentId).update({
                approvalstatus: status,
                approvername: document.getElementById('app_name').value,
                approverposition: document.getElementById('app_pos').value,
                approvalcomment: document.getElementById('app_comment').value,
                approvaldate: firebase.firestore.FieldValue.serverTimestamp(),
                approverSignature: finalSignature // Saves Base64 image
            });

            await Swal.fire("Berjaya!", "Data telah disimpan.", "success");
            location.reload();
        } catch(e) {
            Swal.fire("Gagal", e.message, "error");
        }
    }
}
</script>

</body>
</html>
