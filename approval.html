<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Approver Portal | TALK2YPKT</title>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Orbitron:wght@500;700&display=swap');

    :root {
        --bg-dark: #0f172a;
        --card-bg: #1e293b;
        --gold: #fbbf24; /* Warna Gold untuk VIP/Approver */
        --text: #e2e8f0;
    }

    body { background: var(--bg-dark); color: var(--text); font-family: 'Poppins', sans-serif; padding: 20px; display: flex; justify-content: center; min-height: 100vh; }

    /* Login/Search Container */
    .container { max-width: 800px; width: 100%; margin: 0 auto; }
    
    .header { text-align: center; margin-bottom: 40px; }
    .header img { width: 80px; margin-bottom: 15px; }
    .header h1 { font-family: 'Orbitron'; color: var(--gold); }

    /* PIN SCREEN STYLES */
    #pinScreen {
        max-width: 400px; margin: 100px auto; text-align: center;
        background: var(--card-bg); padding: 40px; border-radius: 15px;
        border: 1px solid var(--gold); box-shadow: 0 0 20px rgba(251, 191, 36, 0.2);
    }
    .pin-input {
        width: 100%; padding: 15px; font-size: 24px; text-align: center; letter-spacing: 10px;
        background: #0f172a; border: 1px solid #475569; color: var(--gold); border-radius: 8px; margin: 20px 0;
    }

    /* UTILITY */
    .hidden { display: none !important; }

    /* Search Box */
    .search-box {
        background: var(--card-bg); padding: 30px; border-radius: 15px;
        text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        border: 1px solid rgba(251, 191, 36, 0.3);
    }
    .input-code {
        width: 70%; padding: 15px; font-size: 18px; border-radius: 8px;
        border: 1px solid #475569; background: #0f172a; color: #fff;
        text-align: center; letter-spacing: 2px;
    }
    .btn-find {
        padding: 15px 30px; background: var(--gold); color: #000; font-weight: bold;
        border: none; border-radius: 8px; cursor: pointer; font-size: 16px; margin-left: 10px;
    }

    /* Form Display */
    #approvalForm { display: none; margin-top: 30px; animation: slideUp 0.5s ease; }
    
    .section-card {
        background: var(--card-bg); padding: 25px; border-radius: 10px; margin-bottom: 20px;
        border-left: 4px solid #64748b;
    }
    .section-title { font-family: 'Orbitron'; color: #94a3b8; margin-bottom: 15px; font-size: 14px; }
    
    .active-section { border-left-color: var(--gold); border: 1px solid var(--gold); }
    .active-section .section-title { color: var(--gold); }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .full { grid-column: span 2; }
    
    label { font-size: 12px; color: #94a3b8; display: block; margin-bottom: 5px; }
    .field-val { 
        background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px; 
        color: #fff; font-size: 14px; border: 1px solid #334155;
    }

    /* Inputs for Section 4 */
    input, select, textarea {
        width: 100%; padding: 12px; background: #020617; border: 1px solid var(--gold);
        color: #fff; border-radius: 5px; outline: none;
    }
    /* Specific override for inputs inside PIN screen/search to avoid clash */
    #pinScreen input, .search-box input { border-color: #475569; }
    #pinScreen input:focus, .search-box input:focus { border-color: var(--gold); }

    .action-bar {
        display: flex; gap: 10px; margin-top: 20px;
    }
    .btn-submit {
        flex: 2; padding: 15px; background: var(--gold); border: none; border-radius: 8px;
        font-weight: bold; cursor: pointer; font-family: 'Orbitron';
    }
    .btn-print {
        flex: 1; padding: 15px; background: #334155; color: #fff; border: none; border-radius: 8px;
        cursor: pointer; font-family: 'Orbitron';
    }

    /* Print Styles */
    @media print {
        body { background: #fff; color: #000; display: block; }
        .search-box, .btn-submit, .btn-print, .header, #pinScreen { display: none !important; }
        .section-card { border: 1px solid #000; box-shadow: none; margin-bottom: 10px; break-inside: avoid; }
        .field-val { background: #fff; border: none; border-bottom: 1px solid #ccc; color: #000; padding: 5px 0; }
        input, textarea, select { border: none; background: none; color: #000; }
        #approvalForm { display: block !important; }
        #mainApp { display: block !important; }
        
        #approvalForm::before {
            content: "OFFICIAL APPROVAL DOCUMENT - YPKT";
            display: block; font-weight: bold; text-align: center; margin-bottom: 20px; font-size: 20px;
        }
    }

    @keyframes slideUp { from {opacity:0; transform:translateY(20px)} to {opacity:1; transform:translateY(0)} }
</style>
</head>
<body>

<div id="pinScreen">
    <img src="Asset/Logo-Yayasan-Pembangunan-Keluarga-Terengganu (1).png" width="80" style="margin-bottom:20px;">
    <h2 style="color:var(--gold); font-family:'Orbitron'">EXECUTIVE ACCESS</h2>
    <p style="font-size:12px; color:#aaa;">SECURE AREA: PLEASE ENTER PIN</p>
    
    <input type="password" id="secretPin" class="pin-input" placeholder="****" maxlength="4">
    <button onclick="checkPin()" class="btn-submit" style="width:100%;">ACCESS PORTAL</button>
</div>

<div id="mainApp" class="container hidden">
    <div class="header">
        <img src="Asset/Logo-Yayasan-Pembangunan-Keluarga-Terengganu (1).png" alt="Logo">
        <h1>EXECUTIVE APPROVAL PORTAL</h1>
        <p style="color:#94a3b8">Welcome, Director. Please enter Reference ID.</p>
    </div>

    <div class="search-box">
        <input type="text" id="searchId" class="input-code" placeholder="Example: YPKT-2023-001">
        <button class="btn-find" onclick="findComplaint()"><i class="fa-solid fa-magnifying-glass"></i> FIND</button>
    </div>

    <div id="approvalForm">
        
        <div class="section-card">
            <div class="section-title">SEC 1 & 2: REPORT DETAILS</div>
            <div class="grid">
                <div><label>ID Ref</label><div class="field-val" id="disp_id"></div></div>
                <div><label>User</label><div class="field-val" id="disp_user"></div></div>
                <div><label>Asset</label><div class="field-val" id="disp_asset"></div></div>
                <div><label>Damage</label><div class="field-val" id="disp_damage"></div></div>
            </div>
        </div>

        <div class="section-card">
            <div class="section-title">SEC 3: IT DEPARTMENT ASSESSMENT</div>
            <div class="grid">
                <div><label>IT Officer</label><div class="field-val" id="disp_it_name"></div></div>
                <div><label>Est. Cost (RM)</label><div class="field-val" id="disp_cost"></div></div>
                <div class="full"><label>Technical Recommendation</label><div class="field-val" id="disp_tech_rec"></div></div>
            </div>
        </div>

        <div class="section-card active-section">
            <div class="section-title"><i class="fa-solid fa-pen-nib"></i> SEC 4: FINAL APPROVAL (ACTION REQUIRED)</div>
            
            <div class="grid">
                <div class="full">
                    <label>Approval Decision</label>
                    <select id="app_status">
                        <option value="Pending">Please Select...</option>
                        <option value="Approve">APPROVE (LULUS)</option>
                        <option value="Reject">REJECT (TIDAK LULUS)</option>
                    </select>
                </div>
                <div>
                    <label>Approver Name</label>
                    <input type="text" id="app_name" value="ENCIK ASHRI" placeholder="Enter Name">
                </div>
                <div>
                    <label>Position</label>
                    <input type="text" id="app_pos" value="PENGARAH" placeholder="e.g. Pengarah">
                </div>
                <div class="full">
                    <label>Comments / Remarks</label>
                    <textarea id="app_comment" rows="3" placeholder="Sebarang catatan tambahan..."></textarea>
                </div>
            </div>

            <div class="action-bar">
                <button class="btn-print" onclick="window.print()">
                    <i class="fa-solid fa-print"></i> PRINT / PDF
                </button>
                <button class="btn-submit" onclick="submitApproval()">
                    <i class="fa-solid fa-check-circle"></i> SUBMIT DECISION
                </button>
            </div>
        </div>

    </div>
</div>

<script>
// --- FIREBASE CONFIG ---
const firebaseConfig={
  apiKey:"AIzaSyDjsNiteoay79tpavm_dfCcKHhRvBfU0Tk",
  authDomain:"e-complaint-8nu9kp.firebaseapp.com",
  projectId:"e-complaint-8nu9kp"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();
const auth=firebase.auth();

// === 1. GHOST LOGIN FUNCTION ===
function checkPin() {
    const pin = document.getElementById('secretPin').value;
    const btn = document.querySelector('#pinScreen button');
    
    if(pin === "1234") { // <--- PIN RAHSIA DISINI
        
        btn.innerHTML = "Authenticating...";
        
        // Login secara senyap di belakang tabir guna akaun khas
        auth.signInWithEmailAndPassword("pengarah@ypkt.gov.my", "ypkt2024")
        .then((userCredential) => {
            // Login Berjaya!
            document.getElementById('pinScreen').classList.add('hidden'); // Sorok PIN
            document.getElementById('mainApp').classList.remove('hidden'); // Tunjuk App
        })
        .catch((error) => {
            console.error(error);
            btn.innerHTML = "ACCESS PORTAL";
            alert("Ralat Sistem: " + error.message);
        });

    } else {
        alert("PIN SALAH! Akses ditolak.");
        document.getElementById('secretPin').value = "";
    }
}


// === 2. FUNGSI ASAL (SEARCH & SUBMIT) ===
let currentId = "";

async function findComplaint() {
    const id = document.getElementById('searchId').value.trim();
    if(!id) return alert("Sila masukkan ID");

    const btn = document.querySelector('.btn-find');
    btn.innerHTML = "Searching...";

    try {
        const doc = await db.collection("complaint").doc(id).get();
        if(doc.exists) {
            const data = doc.data();
            currentId = id;
            
            // Populate Read-Only Data
            document.getElementById('disp_id').innerText = id;
            document.getElementById('disp_user').innerText = data.lastUser || "-";
            document.getElementById('disp_asset').innerText = data.assettype || "-";
            document.getElementById('disp_damage').innerText = data.damagedescription || "-";
            
            document.getElementById('disp_it_name').innerText = data.section3nameposition || "Pending IT";
            document.getElementById('disp_cost').innerText = data.estimatedmaintenancecost || "0.00";
            document.getElementById('disp_tech_rec').innerText = data.recommendsection3 || "-";

            // Populate Existing Approval Data
            document.getElementById('app_status').value = data.approvalstatus || "Pending";
            
            // Auto fill nama kalau kosong, kalau tak ambil dari db
            document.getElementById('app_name').value = data.approvername || "ENCIK ASHRI";
            document.getElementById('app_pos').value = data.approverposition || "PENGARAH";
            document.getElementById('app_comment').value = data.approvalcomment || "";

            document.getElementById('approvalForm').style.display = "block";
        } else {
            alert("ID tidak dijumpai. Sila semak semula.");
            document.getElementById('approvalForm').style.display = "none";
        }
    } catch(e) {
        console.error(e);
        alert("Error connection.");
    }
    btn.innerHTML = '<i class="fa-solid fa-magnifying-glass"></i> FIND';
}

async function submitApproval() {
    if(!currentId) return;

    // Check if user is actually logged in (Safety check)
    if(!auth.currentUser) {
        alert("Session Expired. Please refresh and enter PIN again.");
        return location.reload();
    }

    const status = document.getElementById('app_status').value;
    const name = document.getElementById('app_name').value;
    
    if(status === "Pending") return alert("Sila pilih status Lulus atau Tidak.");
    if(!name) return alert("Sila masukkan nama pengesah.");

    if(!confirm("Adakah anda pasti untuk menghantar keputusan ini?")) return;

    try {
        await db.collection("complaint").doc(currentId).update({
            approvalstatus: status,
            approvername: name,
            approverposition: document.getElementById('app_pos').value,
            approvalcomment: document.getElementById('app_comment').value,
            approvaldate: firebase.firestore.FieldValue.serverTimestamp()
        });

        alert("Berjaya! Keputusan telah direkodkan.");
        location.reload(); 
    } catch(e) {
        alert("Gagal simpan (Permission Error?): " + e.message);
    }
}
</script>

</body>
</html>
