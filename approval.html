<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Approver Portal | TALK2YPKT</title>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Orbitron:wght@500;700&display=swap');

    :root {
        --bg-dark: #0f172a;
        --card-bg: #1e293b;
        --gold: #fbbf24;
        --text: #e2e8f0;
        --border: #334155;
        --green: #10b981;
    }

    body { background: var(--bg-dark); color: var(--text); font-family: 'Poppins', sans-serif; padding: 20px; display: flex; justify-content: center; min-height: 100vh; }
    .container { max-width: 850px; width: 100%; margin: 0 auto; padding-bottom: 50px; }
    .hidden { display: none !important; }

    /* --- PIN SCREEN --- */
    #pinScreen {
        max-width: 400px; margin: 80px auto; text-align: center;
        background: var(--card-bg); padding: 40px; border-radius: 15px;
        border: 1px solid var(--gold); box-shadow: 0 0 20px rgba(251, 191, 36, 0.2);
    }
    .pin-input {
        width: 100%; padding: 15px; font-size: 24px; text-align: center; letter-spacing: 10px;
        background: #0f172a; border: 1px solid #475569; color: var(--gold); border-radius: 8px; margin: 20px 0;
    }

    /* --- HEADER --- */
    .header { display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px; padding-bottom:20px; border-bottom:1px solid var(--border); }
    .header h1 { font-family: 'Orbitron'; color: var(--gold); margin: 0; font-size: 20px; }
    .user-badge { background: rgba(251, 191, 36, 0.1); color: var(--gold); padding: 5px 12px; border-radius: 20px; font-size: 12px; border: 1px solid var(--gold); }

    /* --- DASHBOARD LIST (NEW) --- */
    .dashboard-title { font-family: 'Orbitron'; margin-bottom: 15px; color: #fff; display: flex; align-items: center; gap: 10px; }
    .pending-list { display: grid; gap: 15px; }
    
    .pending-card {
        background: var(--card-bg); padding: 20px; border-radius: 12px;
        border: 1px solid var(--border); cursor: pointer; transition: 0.3s;
        display: flex; justify-content: space-between; align-items: center;
        position: relative; overflow: hidden;
    }
    .pending-card::before { content:''; position:absolute; left:0; top:0; bottom:0; width:4px; background:var(--gold); }
    .pending-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); border-color: var(--gold); }
    
    .card-info h3 { margin: 0; color: #fff; font-size: 16px; font-weight: 600; }
    .card-info p { margin: 5px 0 0; color: #94a3b8; font-size: 12px; }
    .card-status { background: rgba(16, 185, 129, 0.1); color: var(--green); padding: 5px 10px; border-radius: 5px; font-size: 11px; font-weight: bold; }
    .arrow-icon { color: var(--gold); }

    /* --- FORM SECTION --- */
    .section-card { background: var(--card-bg); padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid var(--border); }
    .section-header {
        background: rgba(255,255,255,0.05); padding: 8px 15px; border-radius: 5px;
        margin-bottom: 15px; border-left: 4px solid #64748b;
        font-family: 'Orbitron'; font-size: 13px; color: #94a3b8; font-weight: bold; letter-spacing: 1px;
    }
    .active-section { border-color: var(--gold); box-shadow: 0 0 15px rgba(251, 191, 36, 0.1); }
    .active-section .section-header { border-left-color: var(--gold); color: var(--gold); background: rgba(251, 191, 36, 0.1); }
    
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .full { grid-column: span 2; }
    label { font-size: 11px; color: #64748b; display: block; margin-bottom: 4px; text-transform: uppercase; }
    .field-val { background: #0f172a; padding: 10px; border-radius: 6px; color: #e2e8f0; font-size: 13px; border: 1px solid #334155; min-height: 20px; }
    input, select, textarea { width: 100%; padding: 10px; background: #020617; border: 1px solid var(--gold); color: #fff; border-radius: 6px; outline: none; font-family: 'Poppins', sans-serif; }

    /* SIGNATURE */
    .sig-tabs { display: flex; gap: 10px; margin-bottom: 10px; }
    .tab-btn { flex: 1; padding: 10px; background: #334155; border: none; color: #fff; cursor: pointer; border-radius: 5px; font-size: 12px; }
    .tab-btn.active { background: var(--gold); color: #000; font-weight: bold; }
    canvas { border: 1px solid #ccc; background:#fff; cursor: crosshair; touch-action: none; width: 100%; height: 150px; border-radius: 8px;}
    
    .btn-submit { width: 100%; padding: 15px; background: var(--gold); border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-family: 'Orbitron'; color: #000; font-size: 16px; margin-top: 20px; }
    .btn-back { background: none; border: none; color: #94a3b8; cursor: pointer; margin-bottom: 10px; font-size: 14px; display: flex; align-items: center; gap: 5px; }
    .btn-back:hover { color: #fff; }

</style>
</head>
<body>

<div id="pinScreen">
    <img src="Asset/Logo-Yayasan-Pembangunan-Keluarga-Terengganu (1).png" width="80" style="margin-bottom:20px;">
    <h2 style="color:var(--gold); font-family:'Orbitron'">EXECUTIVE ACCESS</h2>
    <input type="password" id="secretPin" class="pin-input" placeholder="****" maxlength="4">
    <button onclick="checkPin()" class="btn-submit" style="margin-top:0;">ACCESS PORTAL</button>
</div>

<div id="mainApp" class="container hidden">
    
    <div class="header">
        <div>
            <img src="Asset/Logo-Yayasan-Pembangunan-Keluarga-Terengganu (1).png" width="40" style="vertical-align:middle; margin-right:10px;">
            <span style="font-family:'Orbitron'; font-weight:bold; color:#fff;">APPROVAL DASHBOARD</span>
        </div>
        <div class="user-badge"><i class="fa-solid fa-user-tie"></i> TIMBALAN PENGARAH</div>
    </div>

    <div id="dashboardView">
        <div class="dashboard-title">
            <i class="fa-solid fa-clock-rotate-left" style="color:var(--gold)"></i> MENUNGGU KELULUSAN
        </div>
        <div id="loadingMsg" style="text-align:center; color:#64748b; padding:20px;">Checking Database...</div>
        <div id="pendingList" class="pending-list"></div>
    </div>

    <div id="approvalForm" class="hidden">
        
        <button class="btn-back" onclick="showDashboard()">
            <i class="fa-solid fa-arrow-left"></i> KEMBALI KE SENARAI
        </button>

        <div class="section-card">
            <div class="section-header">SEC 1: INFO ASET & PENGADU</div>
            <div class="grid">
                <div><label>ID Aduan</label><div class="field-val" id="v_id" style="color:var(--gold); font-weight:bold;"></div></div>
                <div><label>Jenis Aset</label><div class="field-val" id="v_assettype"></div></div>
                <div><label>No. Siri</label><div class="field-val" id="v_serialNumber"></div></div>
                <div><label>Pengguna Terakhir</label><div class="field-val" id="v_lastUser"></div></div>
                <div class="full"><label>Kerosakan</label><div class="field-val" id="v_damagedescription"></div></div>
            </div>
        </div>

        <div class="section-card">
            <div class="section-header">SEC 2: SYOR PEGAWAI ASET</div>
            <div class="grid">
                <div class="full"><label>Ulasan</label><div class="field-val" id="v_recommendationsection2"></div></div>
            </div>
        </div>

        <div class="section-card">
            <div class="section-header">SEC 3: ULASAN TEKNIKAL (IT)</div>
            <div class="grid">
                <div><label>Pegawai Teknikal</label><div class="field-val" id="v_section3nameposition"></div></div>
                <div><label>Tarikh Semakan</label><div class="field-val" id="v_section3date"></div></div>
                <div><label>Anggaran Kos (RM)</label><div class="field-val" id="v_estimatedmaintenancecost" style="color:var(--green); font-weight:bold;"></div></div>
                <div class="full"><label>Syor Teknikal</label><div class="field-val" id="v_recommendsection3"></div></div>
            </div>
        </div>

        <div class="section-card active-section">
            <div class="section-header"><i class="fa-solid fa-pen-nib"></i> SEC 4: TINDAKAN PENGARAH</div>
            
            <div class="grid">
                <div class="full">
                    <label style="color:var(--gold);">Keputusan</label>
                    <select id="app_status" style="font-size:16px;">
                        <option value="Pending">-- Sila Pilih --</option>
                        <option value="Approve">LULUS (APPROVE)</option>
                        <option value="Reject">TIDAK LULUS (REJECT)</option>
                    </select>
                </div>
                <div><label>Nama</label><input type="text" id="app_name" value="ENCIK ASHRI"></div>
                <div><label>Jawatan</label><input type="text" id="app_pos" value="TIMBALAN PENGARAH"></div>
                <div class="full"><label>Ulasan</label><textarea id="app_comment" rows="2" placeholder="Catatan..."></textarea></div>

                <div class="full" style="margin-top:10px;">
                    <label style="color:var(--gold);">TANDATANGAN</label>
                    <div class="sig-tabs">
                        <button class="tab-btn active" id="btnDraw" onclick="switchSigMode('draw')">LUKIS</button>
                        <button class="tab-btn" id="btnUpload" onclick="switchSigMode('upload')">UPLOAD COP</button>
                    </div>
                    <div id="areaDraw">
                        <canvas id="sigCanvas"></canvas>
                        <div style="text-align:right;"><button onclick="clearSignature()" style="color:#ef4444; background:none; border:none; font-size:12px;">Padam</button></div>
                    </div>
                    <div id="areaUpload" class="hidden">
                        <input type="file" id="sigFile" accept="image/*" onchange="previewSig(this)" style="color:#fff;">
                        <img id="sigPreview" style="max-height:100px; display:none; margin-top:10px; border:1px solid #555;">
                    </div>
                </div>
            </div>

            <button class="btn-submit" onclick="submitApproval()">
                <i class="fa-solid fa-check-circle"></i> SAHKAN KEPUTUSAN
            </button>
        </div>

    </div>
</div>

<script>
// --- CONFIG ---
const firebaseConfig={
  apiKey:"AIzaSyDjsNiteoay79tpavm_dfCcKHhRvBfU0Tk",
  authDomain:"e-complaint-8nu9kp.firebaseapp.com",
  projectId:"e-complaint-8nu9kp"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();
const auth=firebase.auth();

// === 1. LOGIN & LOAD LIST ===
function checkPin() {
    const pin = document.getElementById('secretPin').value;
    if(pin === "1234") { 
        auth.signInWithEmailAndPassword("timbalanpengarah@ypkt.gov.my", "ypkt0101").then(() => {
            document.getElementById('pinScreen').classList.add('hidden'); 
            document.getElementById('mainApp').classList.remove('hidden'); 
            loadPendingList(); // <--- TERUS LOAD LIST
            setupCanvas();
        }).catch(e => Swal.fire("Error", e.message, "error"));
    } else {
        Swal.fire("Salah", "PIN tidak sah", "error");
    }
}

// === 2. AUTO-FETCH PENDING LIST ===
function loadPendingList() {
    const container = document.getElementById('pendingList');
    const msg = document.getElementById('loadingMsg');
    
    // Query: Ambil semua data
    db.collection("complaint").onSnapshot((snapshot) => {
        let html = "";
        let count = 0;

        snapshot.forEach(doc => {
            const d = doc.data();
            
            // LOGIC PENAPISAN (FILTER):
            // 1. Status mestilah "Pending" (atau kosong)
            // 2. Section 3 (IT) MESTI dah ada tarikh (maksudnya Admin dah semak)
            const isPending = !d.approvalstatus || d.approvalstatus === "Pending";
            const isTechDone = d.section3date || d.section3Date; 

            if(isPending && isTechDone) {
                count++;
                html += `
                <div class="pending-card" onclick="openDetail('${doc.id}')">
                    <div class="card-info">
                        <h3>${d.assettype || "Aset Umum"}</h3>
                        <p>ID: ${doc.id} | Oleh: ${d.lastUser}</p>
                        <p style="color:#aaa; font-style:italic;">"${d.damagedescription || ''}"</p>
                    </div>
                    <div>
                        <div class="card-status">READY</div>
                        <div style="text-align:right; margin-top:5px;"><i class="fa-solid fa-chevron-right arrow-icon"></i></div>
                    </div>
                </div>`;
            }
        });

        if(count === 0) {
            msg.innerHTML = "Tiada permohonan yang menunggu kelulusan setakat ini.";
            container.innerHTML = "";
        } else {
            msg.style.display = 'none';
            container.innerHTML = html;
        }
    });
}

// === 3. OPEN DETAIL & SIGNATURE ===
let currentId = "";
let currentSigMode = 'draw';
let canvas, ctx, isDrawing=false, uploadedSigData=null;

async function openDetail(id) {
    currentId = id;
    
    // Tunjuk Loading kejap
    Swal.fire({title:'Loading...', didOpen:()=>{Swal.showLoading()}});
    
    const doc = await db.collection("complaint").doc(id).get();
    const d = doc.data();
    Swal.close();

    // Hide List, Show Form
    document.getElementById('dashboardView').classList.add('hidden');
    document.getElementById('approvalForm').classList.remove('hidden');

    // Fill Data
    const dt = t => t?.toDate ? t.toDate().toLocaleDateString('en-GB') : "-";
    
    document.getElementById('v_id').innerText = id;
    document.getElementById('v_assettype').innerText = d.assettype || "-";
    document.getElementById('v_serialNumber').innerText = d.serialNumber || "-";
    document.getElementById('v_lastUser').innerText = d.lastUser || "-";
    document.getElementById('v_damagedescription').innerText = d.damagedescription || "-";
    
    document.getElementById('v_recommendationsection2').innerText = d.recommendationsection2 || "-";
    
    document.getElementById('v_section3nameposition').innerText = d.section3nameposition || "-";
    document.getElementById('v_section3date').innerText = dt(d.section3date || d.section3Date);
    document.getElementById('v_estimatedmaintenancecost').innerText = "RM " + (d.estimatedmaintenancecost || "0.00");
    document.getElementById('v_recommendsection3').innerText = d.recommendsection3 || "-";

    // Setup Signature Canvas (Reset)
    setTimeout(setupCanvas, 500);
}

function showDashboard() {
    document.getElementById('approvalForm').classList.add('hidden');
    document.getElementById('dashboardView').classList.remove('hidden');
}

// === 4. CANVAS LOGIC ===
function switchSigMode(mode) {
    currentSigMode = mode;
    document.getElementById('btnDraw').className = mode === 'draw' ? 'tab-btn active' : 'tab-btn';
    document.getElementById('btnUpload').className = mode === 'upload' ? 'tab-btn active' : 'tab-btn';
    if(mode === 'draw') {
        document.getElementById('areaDraw').classList.remove('hidden');
        document.getElementById('areaUpload').classList.add('hidden');
        setupCanvas();
    } else {
        document.getElementById('areaDraw').classList.add('hidden');
        document.getElementById('areaUpload').classList.remove('hidden');
    }
}
function setupCanvas(){
    canvas=document.getElementById('sigCanvas'); ctx=canvas.getContext('2d');
    canvas.width=canvas.offsetWidth; canvas.height=150;
    ctx.lineWidth=3; ctx.lineJoin='round'; ctx.lineCap='round'; ctx.strokeStyle='#000';
    canvas.onmousedown=start; canvas.onmousemove=draw; canvas.onmouseup=end;
    canvas.ontouchstart=(e)=>{e.preventDefault();start(e.touches[0])};
    canvas.ontouchmove=(e)=>{e.preventDefault();draw(e.touches[0])};
    canvas.ontouchend=end;
}
function start(e){isDrawing=true; ctx.beginPath(); ctx.moveTo(e.clientX-canvas.getBoundingClientRect().left, e.clientY-canvas.getBoundingClientRect().top);}
function draw(e){if(!isDrawing)return; ctx.lineTo(e.clientX-canvas.getBoundingClientRect().left, e.clientY-canvas.getBoundingClientRect().top); ctx.stroke();}
function end(){isDrawing=false;}
function clearSignature(){ctx.clearRect(0,0,canvas.width,canvas.height);}
function previewSig(input){
    if(input.files[0]){
        const r=new FileReader();
        r.onload=(e)=>{
            uploadedSigData=e.target.result; 
            document.getElementById('sigPreview').src=uploadedSigData;
            document.getElementById('sigPreview').style.display='block';
        };
        r.readAsDataURL(input.files[0]);
    }
}

// === 5. SUBMIT ===
async function submitApproval() {
    const status = document.getElementById('app_status').value;
    if(status === "Pending") return Swal.fire("Sila Pilih", "Lulus atau Tidak?", "warning");

    let sig = "";
    if(currentSigMode === 'draw') sig = canvas.toDataURL("image/png");
    else sig = uploadedSigData;

    Swal.fire({
        title: 'Sahkan?', text: status, icon: 'question', showCancelButton: true, confirmButtonText: 'Ya'
    }).then(async (res) => {
        if(res.isConfirmed) {
            try {
                await db.collection("complaint").doc(currentId).update({
                    approvalstatus: status,
                    approvername: document.getElementById('app_name').value,
                    approverposition: document.getElementById('app_pos').value,
                    approvalcomment: document.getElementById('app_comment').value,
                    approvaldate: firebase.firestore.FieldValue.serverTimestamp(),
                    approverSignature: sig
                });
                
                await Swal.fire("Berjaya", "Telah direkodkan.", "success");
                showDashboard(); // Balik ke list, item tu akan hilang automatik
            } catch(e) { Swal.fire("Ralat", e.message, "error"); }
        }
    });
}
</script>
</body>
</html>
