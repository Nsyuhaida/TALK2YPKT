<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Approver Portal | TALK2YPKT</title>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Orbitron:wght@500;700&display=swap');

    :root {
        --bg-dark: #0f172a;
        --card-bg: #1e293b;
        --gold: #fbbf24;
        --text: #e2e8f0;
        --border: #334155;
    }

    body { background: var(--bg-dark); color: var(--text); font-family: 'Poppins', sans-serif; padding: 20px; display: flex; justify-content: center; min-height: 100vh; }

    .container { max-width: 900px; width: 100%; margin: 0 auto; padding-bottom: 50px; }
    .hidden { display: none !important; }

    /* --- PIN SCREEN --- */
    #pinScreen {
        max-width: 400px; margin: 80px auto; text-align: center;
        background: var(--card-bg); padding: 40px; border-radius: 15px;
        border: 1px solid var(--gold); box-shadow: 0 0 20px rgba(251, 191, 36, 0.2);
    }
    .pin-input {
        width: 100%; padding: 15px; font-size: 24px; text-align: center; letter-spacing: 10px;
        background: #0f172a; border: 1px solid #475569; color: var(--gold); border-radius: 8px; margin: 20px 0;
    }

    /* --- HEADER & SEARCH --- */
    .header { text-align: center; margin-bottom: 30px; }
    .header img { width: 80px; margin-bottom: 15px; }
    .header h1 { font-family: 'Orbitron'; color: var(--gold); margin: 0; font-size: 24px; }
    
    .search-box {
        background: var(--card-bg); padding: 25px; border-radius: 15px;
        text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        border: 1px solid rgba(251, 191, 36, 0.3); margin-bottom: 30px;
    }
    .input-code {
        width: 60%; padding: 12px; font-size: 16px; border-radius: 8px;
        border: 1px solid #475569; background: #0f172a; color: #fff;
        text-align: center; letter-spacing: 1px;
    }
    .btn-find {
        padding: 12px 25px; background: var(--gold); color: #000; font-weight: bold;
        border: none; border-radius: 8px; cursor: pointer; font-size: 14px; margin-left: 10px;
    }

    /* --- SECTION CARDS --- */
    .section-card {
        background: var(--card-bg); padding: 25px; border-radius: 10px; margin-bottom: 25px;
        border: 1px solid var(--border);
    }
    .section-header {
        background: rgba(255,255,255,0.05); padding: 10px 15px; border-radius: 5px;
        margin-bottom: 20px; border-left: 4px solid #64748b;
        font-family: 'Orbitron'; font-size: 14px; color: #94a3b8; font-weight: bold;
    }
    .active-section { border-color: var(--gold); box-shadow: 0 0 15px rgba(251, 191, 36, 0.1); }
    .active-section .section-header { border-left-color: var(--gold); color: var(--gold); background: rgba(251, 191, 36, 0.1); }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .full { grid-column: span 2; }

    label { font-size: 11px; color: #64748b; display: block; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
    .field-val { 
        background: #0f172a; padding: 12px; border-radius: 6px; 
        color: #e2e8f0; font-size: 14px; border: 1px solid #334155; min-height: 20px;
    }

    input, select, textarea {
        width: 100%; padding: 12px; background: #020617; border: 1px solid var(--gold);
        color: #fff; border-radius: 6px; outline: none; box-sizing: border-box; font-family: 'Poppins', sans-serif;
    }

    /* --- SIGNATURE PAD STYLE --- */
    .sig-container {
        background: #fff; border-radius: 8px; padding: 10px; text-align: center;
        border: 2px dashed #475569; position: relative;
    }
    canvas { 
        border: 1px solid #ccc; background: #fff; cursor: crosshair; touch-action: none;
        width: 100%; height: 150px; /* Responsive width */
    }
    .btn-clear-sig {
        background: #ef4444; color: white; border: none; padding: 5px 10px;
        font-size: 12px; border-radius: 4px; cursor: pointer; margin-top: 5px;
    }

    /* BUTTONS */
    .action-bar { display: flex; gap: 15px; margin-top: 20px; }
    .btn-submit {
        flex: 2; padding: 15px; background: var(--gold); border: none; border-radius: 8px;
        font-weight: bold; cursor: pointer; font-family: 'Orbitron'; color: #000; font-size: 16px;
    }
    .btn-print {
        flex: 1; padding: 15px; background: #334155; color: #fff; border: none; border-radius: 8px;
        cursor: pointer; font-family: 'Orbitron'; font-size: 14px;
    }

    @media print {
        .search-box, .btn-submit, .btn-print, .header, #pinScreen, .btn-clear-sig { display: none !important; }
        .container { margin: 0; width: 100%; max-width: 100%; }
        .section-card { border: 1px solid #000; box-shadow: none; margin-bottom: 10px; break-inside: avoid; }
        .field-val { background: #fff; border: none; border-bottom: 1px solid #ccc; color: #000; padding: 5px 0; font-weight: bold; }
        input, textarea, select { border: none; background: none; color: #000; font-weight: bold; }
        canvas { border: none; }
        #approvalForm::before { content: "DIGITAL APPROVAL DOCUMENT"; display: block; font-weight: bold; text-align: center; margin-bottom: 20px; font-size: 18px; text-decoration: underline; }
    }
</style>
</head>
<body>

<div id="pinScreen">
    <img src="Asset/Logo-Yayasan-Pembangunan-Keluarga-Terengganu (1).png" width="80" style="margin-bottom:20px;">
    <h2 style="color:var(--gold); font-family:'Orbitron'">EXECUTIVE ACCESS</h2>
    <p style="font-size:12px; color:#aaa;">SECURE AREA: PLEASE ENTER PIN</p>
    <input type="password" id="secretPin" class="pin-input" placeholder="****" maxlength="4">
    <button onclick="checkPin()" class="btn-submit" style="width:100%;">ACCESS PORTAL</button>
</div>

<div id="mainApp" class="container hidden">
    <div class="header">
        <img src="Asset/Logo-Yayasan-Pembangunan-Keluarga-Terengganu (1).png" alt="Logo">
        <h1>APPROVAL DASHBOARD</h1>
        <p>Log Masuk: Timbalan Pengarah</p>
    </div>

    <div class="search-box">
        <input type="text" id="searchId" class="input-code" placeholder="Enter Ref ID (e.g. YPKT-2023-001)">
        <button class="btn-find" onclick="findComplaint()"><i class="fa-solid fa-magnifying-glass"></i> FIND</button>
    </div>

    <div id="approvalForm" class="hidden">
        
        <div class="section-card">
            <div class="section-header">SEC 1: MAKLUMAT PENGADU & ASET</div>
            <div class="grid">
                <div><label>ID Rujukan</label><div class="field-val" id="d_id"></div></div>
                <div><label>Nama Pengguna</label><div class="field-val" id="d_user"></div></div>
                <div><label>Jenis Aset</label><div class="field-val" id="d_asset"></div></div>
                <div><label>No Siri Aset</label><div class="field-val" id="d_serial"></div></div>
                <div class="full"><label>Keterangan Kerosakan</label><div class="field-val" id="d_desc"></div></div>
            </div>
        </div>

        <div class="section-card">
            <div class="section-header">SEC 2: SYOR PEGAWAI ASET</div>
            <div class="grid">
                <div><label>Nama Pegawai</label><div class="field-val" id="d_sec2_name"></div></div>
                <div><label>Syor / Cadangan</label><div class="field-val" id="d_sec2_rec"></div></div>
            </div>
        </div>

        <div class="section-card">
            <div class="section-header">SEC 3: ULASAN TEKNIKAL (IT)</div>
            <div class="grid">
                <div><label>Pegawai Teknikal</label><div class="field-val" id="d_it_name"></div></div>
                <div><label>Anggaran Kos (RM)</label><div class="field-val" id="d_est_cost"></div></div>
                <div class="full"><label>Ulasan Teknikal</label><div class="field-val" id="d_it_rec"></div></div>
            </div>
        </div>

        <div class="section-card active-section">
            <div class="section-header"><i class="fa-solid fa-pen-nib"></i> SEC 4: KELULUSAN & TANDATANGAN</div>
            
            <div class="grid">
                <div class="full">
                    <label style="color:var(--gold);">STATUS KELULUSAN</label>
                    <select id="app_status" style="font-size:16px;">
                        <option value="Pending">-- Sila Pilih Keputusan --</option>
                        <option value="Approve">LULUS / APPROVE</option>
                        <option value="Not approve">TIDAK LULUS / REJECT</option>
                    </select>
                </div>
                <div>
                    <label>Nama Pelulus</label>
                    <input type="text" id="app_name" value="ENCIK ASHRI" placeholder="Enter Name">
                </div>
                <div>
                    <label>Jawatan</label>
                    <input type="text" id="app_pos" value="TIMBALAN PENGARAH" placeholder="Position">
                </div>
                <div class="full">
                    <label>Ulasan / Catatan</label>
                    <textarea id="app_comment" rows="2" placeholder="Sila masukkan ulasan..."></textarea>
                </div>

                <div class="full">
                    <label style="color:var(--gold); font-size:12px;">TANDATANGAN DIGITAL (Sila tandatangan dalam kotak putih di bawah)</label>
                    <div class="sig-container">
                        <canvas id="sigCanvas"></canvas>
                        <button class="btn-clear-sig" onclick="clearSignature()">
                            <i class="fa-solid fa-eraser"></i> Padam & Sign Semula
                        </button>
                    </div>
                </div>
            </div>

            <div class="action-bar">
                <button class="btn-print" onclick="window.print()"><i class="fa-solid fa-print"></i> PRINT</button>
                <button class="btn-submit" onclick="submitApproval()"><i class="fa-solid fa-check-circle"></i> SAHKAN KEPUTUSAN</button>
            </div>
        </div>

    </div>
</div>

<script>
// --- FIREBASE CONFIG ---
const firebaseConfig={
  apiKey:"AIzaSyDjsNiteoay79tpavm_dfCcKHhRvBfU0Tk",
  authDomain:"e-complaint-8nu9kp.firebaseapp.com",
  projectId:"e-complaint-8nu9kp"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();
const auth=firebase.auth();

// === 1. LOGIN SYSTEM ===
function checkPin() {
    const pin = document.getElementById('secretPin').value;
    const btn = document.querySelector('#pinScreen button');
    
    if(pin === "1234") { 
        btn.innerHTML = "Verifying...";
        auth.signInWithEmailAndPassword("timbalanpengarah@ypkt.gov.my", "ypkt0101")
        .then(() => {
            document.getElementById('pinScreen').classList.add('hidden'); 
            document.getElementById('mainApp').classList.remove('hidden'); 
            setupCanvas(); // Initialize Canvas when logged in
        })
        .catch((error) => {
            btn.innerHTML = "ACCESS PORTAL";
            alert("Ralat Login: " + error.message);
        });
    } else {
        alert("PIN SALAH!");
    }
}

// === 2. CANVAS SIGNATURE LOGIC ===
let canvas, ctx, isDrawing = false;

function setupCanvas() {
    canvas = document.getElementById('sigCanvas');
    ctx = canvas.getContext('2d');
    
    // Set resolusi canvas supaya tak pecah
    canvas.width = canvas.offsetWidth; 
    canvas.height = canvas.offsetHeight;

    ctx.lineWidth = 3;
    ctx.lineJoin = 'round';
    ctx.lineCap = 'round';
    ctx.strokeStyle = '#000000';

    // Mouse Events
    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', endDraw);
    canvas.addEventListener('mouseout', endDraw);

    // Touch Events (Phone/Tablet)
    canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDraw(e.touches[0]); });
    canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e.touches[0]); });
    canvas.addEventListener('touchend', endDraw);
}

function startDraw(e) {
    isDrawing = true;
    const rect = canvas.getBoundingClientRect();
    ctx.beginPath();
    ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
}

function draw(e) {
    if (!isDrawing) return;
    const rect = canvas.getBoundingClientRect();
    ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
    ctx.stroke();
}

function endDraw() { isDrawing = false; }
function clearSignature() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

// === 3. DATA FUNCTIONS ===
const dt = (t) => t && t.toDate ? t.toDate().toLocaleString("en-GB") : "-";
let currentId = "";

async function findComplaint() {
    const id = document.getElementById('searchId').value.trim();
    if(!id) return alert("Sila masukkan ID");

    try {
        const doc = await db.collection("complaint").doc(id).get();
        if(doc.exists) {
            const d = doc.data();
            currentId = id;
            
            // Populate Fields
            document.getElementById('d_id').innerText = id;
            document.getElementById('d_user').innerText = d.lastUser || "-";
            document.getElementById('d_asset').innerText = d.assettype || "-";
            document.getElementById('d_serial').innerText = d.serialNumber || "-";
            document.getElementById('d_desc').innerText = d.damagedescription || "-";
            
            document.getElementById('d_sec2_name').innerText = d.section2nameposition || "-";
            document.getElementById('d_sec2_rec').innerText = d.recommendationsection2 || "-";
            
            document.getElementById('d_it_name').innerText = d.section3nameposition || "Pending IT";
            document.getElementById('d_est_cost').innerText = d.estimatedmaintenancecost || "0.00";
            document.getElementById('d_it_rec').innerText = d.recommendsection3 || "-";

            // Approval Data
            document.getElementById('app_status').value = d.approvalstatus || "Pending";
            document.getElementById('app_name').value = d.approvername || "ENCIK ASHRI";
            document.getElementById('app_pos').value = d.approverposition || "TIMBALAN PENGARAH";
            document.getElementById('app_comment').value = d.approvalcomment || "";

            // Load Existing Signature (Optional: Draw Image if exists)
            // For now we assume new signature every time or just blank
            clearSignature();

            document.getElementById('approvalForm').classList.remove('hidden');
            
            // Resize canvas again to be safe
            setTimeout(() => {
                 canvas.width = canvas.offsetWidth;
                 canvas.height = canvas.offsetHeight;
                 ctx.lineWidth = 3; ctx.lineCap='round';
            }, 500);

        } else {
            alert("ID tidak dijumpai.");
        }
    } catch(e) {
        console.error(e);
        alert("Error connection.");
    }
}

async function submitApproval() {
    if(!currentId) return;
    if(!auth.currentUser) return alert("Sesi tamat.");

    const status = document.getElementById('app_status').value;
    
    if(status === "Pending") return alert("Sila pilih Status.");
    if(!confirm("Hantar keputusan dengan tandatangan ini?")) return;

    // Convert Signature to Base64 String
    const signatureData = canvas.toDataURL("image/png");

    try {
        await db.collection("complaint").doc(currentId).update({
            approvalstatus: status,
            approvername: document.getElementById('app_name').value,
            approverposition: document.getElementById('app_pos').value,
            approvalcomment: document.getElementById('app_comment').value,
            approverSignature: signatureData, // Save Signature Here
            approvaldate: firebase.firestore.FieldValue.serverTimestamp()
        });

        alert("Berjaya! Keputusan dan Tandatangan disimpan.");
        location.reload(); 
    } catch(e) {
        alert("Gagal simpan: " + e.message);
    }
}
</script>

</body>
</html>
