<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Complaint List</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial,sans-serif;}
body{background:#89CFF0;}
.app{display:flex;min-height:100vh;}
.sidebar{width:240px;background:#1e3a8a;color:white;padding:20px;}
.brand{font-size:20px;font-weight:bold;margin-bottom:30px;text-align:center;}
.nav a{display:block;text-decoration:none;color:white;padding:12px;border-radius:8px;margin-bottom:8px;}
.nav a:hover{background:#2563eb;}
.nav a.active{background:#2563eb;}
.main{flex:1;padding:25px;}
h1{font-size:26px;margin-bottom:20px;}
.card{background:white;padding:20px;border-radius:12px;box-shadow:0 6px 15px rgba(0,0,0,0.1);}
table{width:100%;border-collapse:collapse;margin-top:15px;}
th,td{padding:10px;text-align:left;border-bottom:1px solid #ddd;}
th{background:#1e3a8a;color:white;}
tr:hover{background:#f0f4ff;cursor:pointer;}
#searchInput{padding:8px;width:50%;margin-bottom:10px;border-radius:6px;border:1px solid #ccc;}
input{padding:8px;border-radius:6px;border:1px solid #ccc;}
.loading{text-align:center;margin-top:50px;color:#555;}
.error{color:red;font-weight:bold;text-align:center;margin-top:50px;}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;}
.modal-content{background:#fff;padding:25px;border-radius:12px;width:90%;max-width:700px;max-height:90%;overflow-y:auto;}
.close{float:right;font-size:20px;cursor:pointer;}
h3{color:#1e3a8a;margin-top:15px;border-bottom:1px solid #ddd;padding-bottom:5px;}
/* LOGO SAMA MACAM DASHBOARD */
.logo{
  width:60px;      /* kecil, kemas */
  height:auto;
  display:block;
  margin:0 auto 15px;
}
</style>
</head>
<body>

<div class="app">

<!-- SIDEBAR -->
<aside class="sidebar">
  <img src="Asset/Logo-Yayasan-Pembangunan-Keluarga-Terengganu (1).png" 
       alt="Logo YPKT" 
       class="logo">
  <div class="brand">Admin Panel</div>
  <nav class="nav">
    <a href="dashboard.html">Dashboard</a>
    <a href="complaints.html" class="active">Complaints</a>
    <a href="notifications.html">Notifications</a>
    <a href="data-entry.html">Data Entry</a>
    <a href="full-report.html">Full Report</a>
    <a href="faq.html">FAQ</a>
    <a href="#" id="logout">Sign Out</a>
  </nav>
</aside>

<!-- MAIN -->
<main class="main">
  <h1>Complaint List</h1>

  <div class="search-filter">
    <input type="text" id="searchInput" placeholder="Search by Name, ID, or Asset Type">
  </div>

  <div class="card">
    <div id="loading" class="loading">Loading complaints...</div>
    <table id="complaintTable" style="display:none;">
      <thead>
        <tr>
          <th>ID</th>
          <th>Asset Type</th>
          <th>Serial Number</th>
          <th>Last User</th>
          <th>Reporter Name & Position</th>
          <th>Report Date</th>
        </tr>
      </thead>
      <tbody id="complaintBody"></tbody>
    </table>
  </div>
</main>
</div>

<!-- Modal -->
<div id="detailModal" class="modal">
  <div class="modal-content">
    <span class="close" id="closeModal">&times;</span>
    <div id="modalBody"></div>
  </div>
</div>

<script>
// FIREBASE CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyDjsNiteoay79tpavm_dfCcKHhRvBfU0Tk",
  authDomain: "e-complaint-8nu9kp.firebaseapp.com",
  projectId: "e-complaint-8nu9kp",
  storageBucket: "e-complaint-8nu9kp.firebasestorage.app",
  messagingSenderId: "753235646663",
  appId: "1:753235646663:web:f5bc1f4ac7c2ad21d506e2"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// LOGOUT
document.getElementById("logout").onclick = () => {
  firebase.auth().signOut().finally(() => {
    localStorage.removeItem("admin_logged_in");
    window.location.href = "index.html";
  });
};

// HELPER
function formatDate(ts){
  if(!ts || !ts.toDate) return "-";
  return ts.toDate().toLocaleDateString("ms-MY") + " " + ts.toDate().toLocaleTimeString("ms-MY");
}

// LOAD COMPLAINTS
let complaintsData = [];

async function loadComplaints(){
  const tbody = document.getElementById("complaintBody");
  const loading = document.getElementById("loading");

  try{
    const snapshot = await db.collection("complaint").orderBy("reportdatesection1","asc").get();
    complaintsData = [];
    let counter = 1;

    snapshot.forEach(doc => {
      const d = doc.data();
      d._id = doc.id;
      d._code = String(counter).padStart(3,'0');
      counter++;
      complaintsData.push(d);
    });

    if(complaintsData.length===0){
      loading.textContent = "No complaints found.";
      return;
    }

    renderTable();
  }
  catch(err){
    console.error(err);
    loading.className="error";
    loading.textContent="Error loading complaints from Firebase.";
  }
}

function renderTable(){
  const tbody = document.getElementById("complaintBody");
  const table = document.getElementById("complaintTable");
  tbody.innerHTML = "";

  const search = document.getElementById("searchInput").value.toLowerCase();

  const filtered = complaintsData.filter(d=>{
    const matchesSearch = d._code.includes(search) || 
                          (d.assettype??"").toLowerCase().includes(search) || 
                          (d.serialNumber??"").toLowerCase().includes(search) ||
                          (d.lastUser??"").toLowerCase().includes(search) ||
                          (d.reporternamaposition??"").toLowerCase().includes(search);
    return matchesSearch;
  });

  filtered.forEach(d=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${d._code}</td>
      <td>${d.assettype??"-"}</td>
      <td>${d.serialNumber??"-"}</td>
      <td>${d.lastUser??"-"}</td>
      <td>${d.reporternamaposition??"-"}</td>
      <td>${formatDate(d.reportdatesection1)}</td>
    `;
    tr.onclick = ()=> showDetails(d);
    tbody.appendChild(tr);
  });

  document.getElementById("loading").style.display = "none";
  table.style.display = "table";
}

// SHOW MODAL WITH FULL DETAILS
function showDetails(d){
  const modal = document.getElementById("detailModal");
  const body = document.getElementById("modalBody");

  body.innerHTML = `
    <h3>Complaint ID: ${d._code}</h3>
    <p><b>Asset Type:</b> ${d.assettype??"-"}</p>
    <p><b>Serial Number:</b> ${d.serialNumber??"-"}</p>
    <p><b>Last User:</b> ${d.lastUser??"-"}</p>
    <p><b>Damage Date:</b> ${formatDate(d.damagedate)}</p>
    <p><b>Damage Description:</b> ${d.damagedescription??"-"}</p>
    <p><b>Reporter Name & Position:</b> ${d.reporternamaposition??"-"}</p>
    <p><b>Report Date Section 1:</b> ${formatDate(d.reportdatesection1)}</p>
    <p><b>Recommendation Section 2:</b> ${d.recommendationsection2??"-"}</p>
    <p><b>Section 2 Name & Position:</b> ${d.section2nameposition??"-"}</p>
    <p><b>Section 2 Date:</b> ${formatDate(d.section2date)}</p>
  `;

  modal.style.display="flex";
}

document.getElementById("closeModal").onclick = ()=>{
  document.getElementById("detailModal").style.display="none";
};

document.getElementById("searchInput").oninput = renderTable;

loadComplaints();
</script>

</body>
</html>
