<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Data Entry Terminal | TALK2YPKT ADMIN</title>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">

<style>
/* --- 1. DESIGN SYSTEM (SAMA MACAM DASHBOARD) --- */
:root {
  --neon-blue: #00f3ff;
  --neon-green: #00ff9d;
  --neon-gold: #fbbf24;
  --neon-red: #ff4d4d;
  --bg-dark: #020617;
  --glass: rgba(15, 23, 42, 0.95);
  --border: rgba(0, 243, 255, 0.2);
}

* { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins',sans-serif; scroll-behavior: smooth; }

body {
  background: linear-gradient(-45deg, #020617, #0f172a, #1e3a8a, #020617);
  background-size: 400% 400%; animation: bgMove 20s ease infinite;
  color: #e2e8f0; min-height: 100vh; overflow-x: hidden;
}
body::before {
  content: ""; position: fixed; inset: 0;
  background-image: linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px),
  linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
  background-size: 40px 40px; pointer-events: none; z-index: 0;
}

.app { display:flex; min-height:100vh; position: relative; z-index: 1; }

/* --- 2. SIDEBAR & HAMBURGER --- */
.sidebar {
  width: 260px; 
  background: var(--glass); 
  backdrop-filter: blur(15px);
  border-right: 1px solid var(--border); 
  padding: 30px 20px;
  display: flex; flex-direction: column; 
  position: sticky; top: 0; height: 100vh;
  z-index: 100;
  transition: transform 0.3s ease, left 0.3s ease; /* Smooth slide for mobile */
}

.logo { width: 70px; display: block; margin: 0 auto 15px; filter: drop-shadow(0 0 10px rgba(255,255,255,0.3)); }
.brand {
  font-family: 'Orbitron', sans-serif; font-size: 18px; font-weight: 700;
  text-align: center; color: var(--neon-blue); letter-spacing: 2px; margin-bottom: 40px;
}
.nav-links { flex: 1; display: flex; flex-direction: column; }
.nav a {
  display: flex; align-items: center; gap: 12px; text-decoration: none; color: rgba(255,255,255,0.7);
  padding: 14px 18px; border-radius: 12px; margin-bottom: 10px; transition: 0.3s;
  font-size: 14px; border: 1px solid transparent;
}
.nav a:hover, .nav a.active {
  background: rgba(0, 243, 255, 0.1); color: #fff; border-color: var(--border);
  box-shadow: 0 0 15px rgba(0, 243, 255, 0.15);
}
.nav a i { width: 20px; text-align: center; }
#logout {
  margin-top: auto; color: var(--neon-red);
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  padding-top: 20px; border-radius: 0; cursor: pointer;
}

/* OVERLAY GELAP UNTUK MOBILE */
.sidebar-overlay { 
    position: fixed; inset: 0; background: rgba(0,0,0,0.8); 
    z-index: 90; display: none; backdrop-filter: blur(5px); 
}
.sidebar-overlay.active { display: block; }

/* --- 3. MAIN CONTENT --- */
.main { flex:1; padding:30px; width: 100%; overflow-x: hidden; }

/* MOBILE HEADER (HAMBURGER) */
.mobile-header { display: none; align-items: center; justify-content: space-between; margin-bottom: 20px; }
.mobile-toggle { 
    background: none; border: none; color: var(--neon-blue); 
    font-size: 24px; cursor: pointer; padding: 5px; 
}

h1 { font-family: 'Orbitron', sans-serif; font-size: 28px; color: #fff; margin-bottom: 25px; }

/* SEARCH INPUT */
.search-container { margin-bottom: 25px; }
#searchInput { 
    width: 100%; max-width: 600px; padding: 12px 20px; 
    background: rgba(0,0,0,0.4); border: 1px solid var(--border); 
    border-radius: 50px; color: #fff; outline: none; transition: 0.3s; 
}
#searchInput:focus { border-color: var(--neon-blue); box-shadow: 0 0 15px rgba(0, 243, 255, 0.2); }

/* --- 4. TABLE RESPONSIVE (SCROLL TEPI) --- */
.table-card { 
    background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(10px); 
    border-radius: 16px; border: 1px solid var(--border); 
    padding: 0; margin-bottom: 30px; 
    max-height: 400px; 
    overflow-y: auto; /* Scroll atas bawah */
    overflow-x: auto; /* Scroll tepi (PENTING UTK PHONE) */
}
table { width:100%; border-collapse: collapse; min-width: 600px; /* Paksa table lebar supaya boleh scroll */ }
th { background: rgba(0, 243, 255, 0.1); position: sticky; top: 0; color: var(--neon-blue); padding: 15px; text-align: left; font-family: 'Orbitron'; font-size: 12px; white-space: nowrap; }
td { padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); color: #ccc; font-size: 13px; cursor: pointer; white-space: nowrap; }
tr:hover { background: rgba(0, 243, 255, 0.05); color: #fff; }

/* FORM STYLE */
.card { 
    background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(15px); padding: 40px; 
    border-radius: 16px; border: 1px solid var(--border); 
    display: none; margin-bottom: 50px; animation: fadeIn 0.5s ease; 
}
h2 { font-family:'Orbitron'; color:#fff; border-bottom:2px solid var(--neon-blue); padding-bottom:10px; margin-bottom:20px; font-size: 20px; }
h3 { font-family: 'Orbitron'; color: var(--neon-blue); margin-top: 25px; margin-bottom: 15px; font-size: 14px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; }

.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.full-width { grid-column: span 2; }

label { display: block; color: rgba(255,255,255,0.6); font-size: 11px; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
.input { width: 100%; padding: 12px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #fff; outline: none; transition: 0.3s; }
.input:focus { border-color: var(--neon-green); box-shadow: 0 0 10px rgba(0, 255, 157, 0.2); }
.input[readonly] { background: rgba(255, 255, 255, 0.03); color: var(--neon-blue); border-color: transparent; }

/* DECISION BOX (LOGIC BARU) */
.decision-box {
    grid-column: span 2;
    margin-top: 25px; padding: 20px;
    border: 1px solid var(--neon-gold);
    background: rgba(251, 191, 36, 0.05);
    border-radius: 8px;
}
.decision-title { color: var(--neon-gold); font-family: 'Orbitron'; font-size: 14px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
.decision-select { background: #000; border: 1px solid var(--neon-gold); color: var(--neon-gold); font-weight: bold; cursor: pointer; }
.info-text { margin-top:10px; font-size:11px; color:#94a3b8; line-height: 1.4; }

.btn-primary { width: 100%; padding: 15px; border: none; border-radius: 50px; cursor: pointer; background: var(--neon-blue); color: #000; font-family: 'Orbitron'; font-weight: bold; margin-top: 20px; transition:0.3s; font-size: 16px; }
.btn-primary:hover { background: #fff; box-shadow: 0 0 20px var(--neon-blue); transform: scale(1.02); }

/* --- 5. MEDIA QUERIES (UNTUK PHONE) --- */
@media (max-width: 768px) {
    /* Sidebar sorok ke kiri */
    .sidebar { position: fixed; left: -100%; width: 80%; max-width: 300px; box-shadow: 10px 0 20px rgba(0,0,0,0.5); }
    /* Sidebar bila active (muncul) */
    .sidebar.active { left: 0; }
    
    .mobile-header { display: flex; } /* Tunjuk Hamburger */
    .main { padding: 20px; }
    
    /* Form jadi satu column memanjang ke bawah */
    .form-grid { grid-template-columns: 1fr; }
    .full-width { grid-column: span 1; }
    .decision-box { grid-column: span 1; }
    
    /* Adjust text size */
    h1 { font-size: 22px; }
    .card { padding: 20px; }
}

@keyframes bgMove { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
@keyframes fadeIn { from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)} }
</style>
</head>

<body>

<div class="app">
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <aside class="sidebar" id="sidebar">
        <img src="Asset/Logo-Yayasan-Pembangunan-Keluarga-Terengganu (1).png" alt="Logo YPKT" class="logo">
        <div class="brand">TALK2YPKT ADMIN</div>
        
        <div class="nav nav-links">
            <a href="dashboard.html"><i class="fa-solid fa-chart-line"></i> Dashboard</a>
            <a href="complaints.html"><i class="fa-solid fa-file-shield"></i> Complaints</a>
            <a href="notifications.html"><i class="fa-solid fa-bell"></i> Notifications</a>
            <a href="data-entry.html" class="active"><i class="fa-solid fa-database"></i> Data Entry</a>
            <a href="full-report.html"><i class="fa-solid fa-clipboard-list"></i> Full Report</a>
            <a href="faq.html"><i class="fa-solid fa-circle-question"></i> FAQ</a>
        </div>

        <div class="nav">
            <a id="logout"><i class="fa-solid fa-power-off"></i> Sign Out</a>
        </div>
    </aside>

    <main class="main">
        <div class="mobile-header">
            <button class="mobile-toggle" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
            <div style="font-family:'Orbitron'; font-weight:bold; color:var(--neon-blue);">DATA TERMINAL</div>
            <div style="width:24px;"></div>
        </div>

        <h1><i class="fa-solid fa-terminal"></i> DATA ENTRY TERMINAL</h1>

        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Cari (ID / Nama User)...">
        </div>

        <div class="table-card" id="complaintList">
            <div style="padding:20px; text-align:center; color:#777;">Loading Data...</div>
        </div>

        <div id="complaintDetail" class="card">
            <h2>UPDATE RECORD</h2>

            <h3>SEC.1: MAKLUMAT PENGADU (READ ONLY)</h3>
            <div class="form-grid">
                <div><label>Jenis Aset</label><input class="input" id="assettype" readonly></div>
                <div><label>No. Siri</label><input class="input" id="SerialNumber" readonly></div>
                <div><label>Dilapor Oleh</label><input class="input" id="lastUser" readonly></div>
                <div><label>Tarikh Rosak</label><input class="input" id="damagedate" readonly></div>
                <div class="full-width"><label>Kerosakan</label><textarea class="input" id="damagedescription" readonly></textarea></div>
            </div>

            <h3>SEC.2: ULASAN PEGAWAI (READ ONLY)</h3>
            <div class="form-grid">
                <div class="full-width"><label>Ulasan Pegawai Penyiasat</label><textarea class="input" id="recommendationsection2" readonly></textarea></div>
                <div><label>Nama Pegawai</label><input class="input" id="section2nameposition" readonly></div>
                <div><label>Tarikh</label><input class="input" id="section2date" readonly></div>
            </div>

            <h3 style="color:var(--neon-green); border-color: var(--neon-green);">
                SEC.3: PENILAIAN TEKNIKAL (ADMIN IT)
            </h3>
            <div class="form-grid">
                <div><label>Kos Terdahulu (RM)</label><input class="input" type="number" id="previousmaintenancecost" placeholder="0.00"></div>
                <div><label>Anggaran Kos (RM)</label><input class="input" type="number" id="estimatedmaintenancecost" placeholder="0.00"></div>
                <div class="full-width"><label>Tindakan Teknikal / Ulasan</label><textarea class="input" id="recommendsection3" placeholder="Masukkan ulasan teknikal..."></textarea></div>
                <div><label>Nama Pegawai IT</label><input class="input" id="section3nameposition"></div>
                <div><label>Tarikh</label><input class="input" type="datetime-local" id="section3date"></div>

                <div class="decision-box">
                    <div class="decision-title"><i class="fa-solid fa-gavel"></i> TINDAKAN KELULUSAN (SECTION 4)</div>
                    <p style="font-size:12px; color:#ccc; margin-bottom:10px;">Sila pilih kaedah kelulusan seterusnya:</p>
                    
                    <select id="approvalMode" class="input decision-select">
                        <option value="Pending">1. PROSES ONLINE (Hantar ke Dashboard Pengarah)</option>
                        <option value="Hardcopy">2. PROSES HARDCOPY (Borang Fizikal Selesai)</option>
                    </select>
                    
                    <div class="info-text">
                        <i class="fa-solid fa-circle-info"></i> <b>Nota:</b><br>
                        • <b>Online:</b> Status kekal "Pending". Pengarah perlu sign digital.<br>
                        • <b>Hardcopy:</b> Status jadi "Approve" automatik. Tandatangan digital dikosongkan.
                    </div>
                </div>
            </div>

            <button class="btn-primary" id="saveComplaint">
                <i class="fa-solid fa-floppy-disk"></i> KEMASKINI & SIMPAN
            </button>
        </div>
    </main>
</div>

<script>
// --- CONFIG FIREBASE ---
const firebaseConfig={
  apiKey:"AIzaSyDjsNiteoay79tpavm_dfCcKHhRvBfU0Tk",
  authDomain:"e-complaint-8nu9kp.firebaseapp.com",
  projectId:"e-complaint-8nu9kp"
};
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const db=firebase.firestore();
const auth=firebase.auth();

// --- AUTH CHECK ---
auth.onAuthStateChanged((user) => {
    if (user && user.email.endsWith('@ypkt.gov.my')) {
        loadComplaints();
    } else {
        window.location.href = "login.html";
    }
});
document.getElementById("logout").onclick = () => auth.signOut();

// --- SIDEBAR FUNCTION (MOBILE) ---
function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('active');
    document.querySelector('.sidebar-overlay').classList.toggle('active');
}

// --- UTILS DATE ---
const dt = (t) => {
    if (!t || !t.toDate) return "";
    const d = t.toDate();
    const offset = d.getTimezoneOffset() * 60000;
    const local = new Date(d.getTime() - offset);
    return local.toISOString().slice(0, 16);
};
const displayDate = (t) => {
    if (!t || !t.toDate) return "-";
    return t.toDate().toLocaleString('ms-MY');
}

// --- DATA LOGIC ---
let complaints=[];

async function loadComplaints(){
    try {
        const s = await db.collection("complaint").orderBy("updatedAt", "desc").limit(50).get();
        complaints = s.docs.map(d => ({id:d.id, ...d.data()}));
        renderTable(complaints);
    } catch(e) { console.error(e); }
}

function renderTable(list){
    const div = document.getElementById("complaintList");
    if(list.length === 0) { div.innerHTML = "<div style='padding:20px;text-align:center'>Tiada Rekod</div>"; return; }
    
    let h = "<table><thead><tr><th>ID</th><th>PENGADU</th><th>STATUS</th></tr></thead><tbody>";
    list.forEach(c => {
        let s = c.approvalstatus || "Pending";
        let color = (s === 'Approve') ? '#00ff9d' : (s === 'Reject' ? '#ff4d4d' : '#ccc');
        
        h += `<tr onclick="loadDetail('${c.id}')">
            <td style="color:var(--neon-blue);font-family:'Orbitron'">${c.id}</td>
            <td>${c.lastUser||"-"}</td>
            <td style="color:${color};font-weight:bold;font-size:11px;">${s.toUpperCase()}</td>
        </tr>`;
    });
    h += "</tbody></table>";
    div.innerHTML = h;
}

document.getElementById("searchInput").oninput = (e) => {
    const v = e.target.value.toLowerCase();
    renderTable(complaints.filter(c => 
        c.id.toLowerCase().includes(v) || 
        (c.lastUser||"").toLowerCase().includes(v)
    ));
};

// --- LOAD DETAIL & FIX SECTION 2 ---
async function loadDetail(id){
    const d = complaints.find(c => c.id === id);
    if(!d) return;

    const form = document.getElementById("complaintDetail");
    form.style.display="block";
    form.dataset.id = id;

    const setVal = (eid, val) => document.getElementById(eid).value = val || "";
    
    // SEC 1
    setVal('assettype', d.assettype);
    setVal('SerialNumber', d.serialNumber);
    setVal('lastUser', d.lastUser);
    setVal('damagedate', displayDate(d.damagedate));
    setVal('damagedescription', d.damagedescription);

    // SEC 2 (PASTIKAN FIELD NAME BETUL DI SINI)
    setVal('recommendationsection2', d.recommendationsection2 || d.section2recommendation); // Cuba dua-dua nama field
    setVal('section2nameposition', d.section2nameposition);
    setVal('section2date', displayDate(d.section2date));

    // SEC 3 (IT INPUT)
    setVal('previousmaintenancecost', d.previousmaintenancecost);
    setVal('estimatedmaintenancecost', d.estimatedmaintenancecost);
    setVal('recommendsection3', d.recommendsection3);
    setVal('section3nameposition', d.section3nameposition);
    
    // Set Date Default to NOW if empty
    if(d.section3date) {
        document.getElementById('section3date').value = dt(d.section3date);
    } else {
        const now = new Date();
        const offset = now.getTimezoneOffset() * 60000;
        document.getElementById('section3date').value = new Date(now - offset).toISOString().slice(0, 16);
    }

    // LOGIC CHECK STATUS UNTUK DROPDOWN
    // Kalau dah Approve TAPI signature kosong -> Hardcopy
    const isHardcopy = (d.approvalstatus === 'Approve' && !d.approverSignature);
    document.getElementById("approvalMode").value = isHardcopy ? "Hardcopy" : "Pending";

    // Scroll ke form
    form.scrollIntoView({behavior: "smooth"});
    // Tutup sidebar kalau di mobile lepas click
    if(window.innerWidth <= 768) {
        document.getElementById('sidebar').classList.remove('active');
        document.querySelector('.sidebar-overlay').classList.remove('active');
    }
}

// --- SAVE FUNCTION ---
document.getElementById("saveComplaint").onclick = async () => {
    const id = document.getElementById("complaintDetail").dataset.id;
    if(!id) return;

    const getVal = (id) => document.getElementById(id).value;
    const mode = document.getElementById("approvalMode").value;

    let updateData = {
        previousmaintenancecost: +getVal('previousmaintenancecost') || 0,
        estimatedmaintenancecost: +getVal('estimatedmaintenancecost') || 0,
        recommendsection3: getVal('recommendsection3'),
        section3nameposition: getVal('section3nameposition'),
        section3date: getVal('section3date') ? firebase.firestore.Timestamp.fromDate(new Date(getVal('section3date'))) : null,
        updatedBy: auth.currentUser.email,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    // LOGIC PENTING:
    if (mode === "Hardcopy") {
        // Jika Hardcopy: Terus APPROVE & Kosongkan Signature
        updateData.approvalstatus = "Approve";
        updateData.approvername = "Manual (Hardcopy)";
        updateData.approverposition = "Manual";
        updateData.approvaldate = firebase.firestore.FieldValue.serverTimestamp();
        updateData.approvalcomment = "Selesai secara Manual/Hardcopy.";
        updateData.approverSignature = ""; // Kosongkan signature utk trigger logic dashboard
    } 
    // Jika "Pending", status tak diusik, tunggu Pengarah approve online.

    try {
        await db.collection("complaint").doc(id).set(updateData, {merge:true});
        Swal.fire({
            title: "Berjaya!",
            text: "Data telah dikemaskini.",
            icon: "success",
            background: '#0f172a', color: '#fff'
        });
        loadComplaints();
    } catch(e) {
        Swal.fire("Error", e.message, "error");
    }
};
</script>

</body>
</html>
