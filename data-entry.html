<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Data Entry Terminal | TALK2YPKT ADMIN</title>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">

<style>
/* --- 1. DESIGN SYSTEM --- */
:root {
  --neon-blue: #00f3ff;
  --neon-green: #00ff9d;
  --neon-gold: #fbbf24;
  --neon-red: #ff4d4d;
  --bg-dark: #020617;
  --glass: rgba(15, 23, 42, 0.95);
  --border: rgba(0, 243, 255, 0.2);
}

* { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins',sans-serif; scroll-behavior: smooth; }

body {
  background: linear-gradient(-45deg, #020617, #0f172a, #1e3a8a, #020617);
  background-size: 400% 400%; animation: bgMove 20s ease infinite;
  color: #e2e8f0; min-height: 100vh; overflow-x: hidden;
}
body::before {
  content: ""; position: fixed; inset: 0;
  background-image: linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px),
  linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
  background-size: 40px 40px; pointer-events: none; z-index: 0;
}

.app { display:flex; min-height:100vh; position: relative; z-index: 1; }

/* --- 2. SIDEBAR & MOBILE NAV --- */
.sidebar {
  width: 260px; 
  background: var(--glass); 
  backdrop-filter: blur(15px);
  border-right: 1px solid var(--border); 
  padding: 30px 20px;
  display: flex; flex-direction: column; 
  position: sticky; top: 0; height: 100vh;
  z-index: 100;
  transition: transform 0.3s ease, left 0.3s ease;
}

.logo { width: 70px; display: block; margin: 0 auto 15px; filter: drop-shadow(0 0 10px rgba(255,255,255,0.3)); }
.brand { font-family: 'Orbitron', sans-serif; font-size: 18px; font-weight: 700; text-align: center; color: var(--neon-blue); letter-spacing: 2px; margin-bottom: 40px; }
.nav-links { flex: 1; display: flex; flex-direction: column; }
.nav a { display: flex; align-items: center; gap: 12px; text-decoration: none; color: rgba(255,255,255,0.7); padding: 14px 18px; border-radius: 12px; margin-bottom: 10px; transition: 0.3s; font-size: 14px; border: 1px solid transparent; }
.nav a:hover, .nav a.active { background: rgba(0, 243, 255, 0.1); color: #fff; border-color: var(--border); box-shadow: 0 0 15px rgba(0, 243, 255, 0.15); }
.nav a i { width: 20px; text-align: center; }
#logout { margin-top: auto; color: var(--neon-red); border-top: 1px solid rgba(255, 255, 255, 0.1); padding-top: 20px; border-radius: 0; cursor: pointer; }
.sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 90; display: none; backdrop-filter: blur(5px); }
.sidebar-overlay.active { display: block; }

/* --- 3. MAIN CONTENT --- */
.main { flex:1; padding:30px; width: 100%; overflow-x: hidden; }
.mobile-header { display: none; align-items: center; justify-content: space-between; margin-bottom: 20px; }
.mobile-toggle { background: none; border: none; color: var(--neon-blue); font-size: 24px; cursor: pointer; padding: 5px; }

h1 { font-family: 'Orbitron', sans-serif; font-size: 28px; color: #fff; margin-bottom: 25px; }

/* SEARCH */
.search-container { margin-bottom: 25px; }
#searchInput { width: 100%; max-width: 600px; padding: 12px 20px; background: rgba(0,0,0,0.4); border: 1px solid var(--border); border-radius: 50px; color: #fff; outline: none; transition: 0.3s; }
#searchInput:focus { border-color: var(--neon-blue); box-shadow: 0 0 15px rgba(0, 243, 255, 0.2); }

/* TABLE RESPONSIVE */
.table-card { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(10px); border-radius: 16px; border: 1px solid var(--border); padding: 0; margin-bottom: 30px; max-height: 400px; overflow-y: auto; overflow-x: auto; }
table { width:100%; border-collapse: collapse; min-width: 600px; }
th { background: rgba(0, 243, 255, 0.1); position: sticky; top: 0; color: var(--neon-blue); padding: 15px; text-align: left; font-family: 'Orbitron'; font-size: 12px; white-space: nowrap; }
td { padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); color: #ccc; font-size: 13px; cursor: pointer; white-space: nowrap; }
tr:hover { background: rgba(0, 243, 255, 0.05); color: #fff; }

/* FORM */
.card { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(15px); padding: 40px; border-radius: 16px; border: 1px solid var(--border); display: none; margin-bottom: 50px; animation: fadeIn 0.5s ease; }
h2 { font-family:'Orbitron'; color:#fff; border-bottom:2px solid var(--neon-blue); padding-bottom:10px; margin-bottom:20px; font-size: 20px; }
h3 { font-family: 'Orbitron'; color: var(--neon-blue); margin-top: 25px; margin-bottom: 15px; font-size: 14px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; }

.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.full-width { grid-column: span 2; }
label { display: block; color: rgba(255,255,255,0.6); font-size: 11px; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
.input { width: 100%; padding: 12px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #fff; outline: none; transition: 0.3s; }
.input:focus { border-color: var(--neon-green); box-shadow: 0 0 10px rgba(0, 255, 157, 0.2); }
.input[readonly] { background: rgba(255, 255, 255, 0.03); color: var(--neon-blue); border-color: transparent; }

/* DECISION BOX */
.decision-box { grid-column: span 2; margin-top: 25px; padding: 20px; border: 1px solid var(--neon-gold); background: rgba(251, 191, 36, 0.05); border-radius: 8px; }
.decision-title { color: var(--neon-gold); font-family: 'Orbitron'; font-size: 14px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
.decision-select { background: #000; border: 1px solid var(--neon-gold); color: var(--neon-gold); font-weight: bold; cursor: pointer; }
.info-text { margin-top:10px; font-size:11px; color:#94a3b8; line-height: 1.4; }

.btn-primary { width: 100%; padding: 15px; border: none; border-radius: 50px; cursor: pointer; background: var(--neon-blue); color: #000; font-family: 'Orbitron'; font-weight: bold; margin-top: 20px; transition:0.3s; font-size: 16px; }
.btn-primary:hover { background: #fff; box-shadow: 0 0 20px var(--neon-blue); transform: scale(1.02); }

/* SWEETALERT CUSTOM */
div:where(.swal2-container) div:where(.swal2-popup) { background: rgba(2, 6, 23, 0.95) !important; border: 1px solid var(--neon-green); border-radius: 15px; backdrop-filter: blur(10px); }
div:where(.swal2-title) { font-family: 'Orbitron' !important; color: var(--neon-green) !important; }
div:where(.swal2-html-container) { color: #cbd5e1 !important; }
div:where(.swal2-confirm) { background-color: var(--neon-green) !important; color: #000 !important; font-family: 'Orbitron' !important; border-radius: 50px !important; }

@media (max-width: 768px) {
  .sidebar { position: fixed; left: -100%; width: 80%; max-width: 300px; box-shadow: 10px 0 20px rgba(0,0,0,0.5); }
  .sidebar.active { left: 0; }
  .mobile-header { display: flex; }
  .main { padding: 20px; }
  .form-grid { grid-template-columns: 1fr; }
  .full-width { grid-column: span 1; }
  .decision-box { grid-column: span 1; }
}
@keyframes bgMove { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
@keyframes fadeIn { from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)} }
</style>
</head>

<body>

<div class="app">
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <aside class="sidebar" id="sidebar">
        <img src="Asset/Logo-Yayasan-Pembangunan-Keluarga-Terengganu (1).png" alt="Logo YPKT" class="logo">
        <div class="brand">TALK2YPKT ADMIN</div>
        
        <div class="nav nav-links">
            <a href="dashboard.html"><i class="fa-solid fa-chart-line"></i> Dashboard</a>
            <a href="complaints.html"><i class="fa-solid fa-file-shield"></i> Complaints</a>
            <a href="notifications.html"><i class="fa-solid fa-bell"></i> Notifications</a>
            <a href="data-entry.html" class="active"><i class="fa-solid fa-database"></i> Data Entry</a>
            <a href="full-report.html"><i class="fa-solid fa-clipboard-list"></i> Full Report</a>
            <a href="faq.html"><i class="fa-solid fa-circle-question"></i> FAQ</a>
        </div>

        <div class="nav">
            <a id="logout"><i class="fa-solid fa-power-off"></i> Sign Out</a>
        </div>
    </aside>

    <main class="main">
        <div class="mobile-header">
            <button class="mobile-toggle" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
            <div style="font-family:'Orbitron'; font-weight:bold; color:var(--neon-blue);">DATA TERMINAL</div>
            <div style="width:24px;"></div>
        </div>

        <h1><i class="fa-solid fa-terminal"></i> DATA ENTRY TERMINAL</h1>

        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Cari (ID / Nama User)...">
        </div>

        <div class="table-card" id="complaintList">
            <div style="padding:20px; text-align:center; color:#777;">Initializing Data Stream...</div>
        </div>

        <div id="complaintDetail" class="card">
            <h2>UPDATE RECORD</h2>

            <h3>SEC.1: COMPLAINANT INFORMATION (READ ONLY)</h3>
            <div class="form-grid">
                <div><label>Asset Type</label><input class="input" id="assettype" readonly></div>
                <div><label>SERIAL NUMBER</label><input class="input" id="SerialNumber" readonly></div>
                <div><label>Reported By</label><input class="input" id="lastUser" readonly></div>
                <div><label>Damaged Date</label><input class="input" id="damagedate" readonly></div>
                <div class="full-width"><label>Damage description</label><textarea class="input" id="damagedescription" readonly></textarea></div>
            </div>

            <h3>SEC.2: OFFICER'S REVIEW AREA OFFICER (READ ONLY)</h3>
            <div class="form-grid">
                <div class="full-width"><label>Investigating Officer's Review</label><textarea class="input" id="recommendationsection2" readonly></textarea></div>
                <div><label>Officer Name</label><input class="input" id="section2nameposition" readonly></div>
                <div><label>Date</label><input class="input" id="section2date" readonly></div>
            </div>

            <h3 style="color:var(--neon-green); border-color: var(--neon-green);">
                SEC.3: TECHNICAL ASSESSMENT (ADMIN IT)
            </h3>
            <div class="form-grid">
                <div><label>Previous Cost (RM) <span style="color:var(--neon-red)">*</span></label><input class="input" type="number" id="previousmaintenancecost" placeholder="0.00" required></div>
                <div><label>Cost Estimate (RM) <span style="color:var(--neon-red)">*</span></label><input class="input" type="number" id="estimatedmaintenancecost" placeholder="0.00" required></div>
                <div class="full-width"><label>Technical Action / Review <span style="color:var(--neon-red)">*</span></label><textarea class="input" id="recommendsection3" placeholder="Masukkan ulasan teknikal..." required></textarea></div>
                <div><label>Name of IT Officer <span style="color:var(--neon-red)">*</span></label><input class="input" id="section3nameposition" required></div>
                <div><label>Date</label><input class="input" type="datetime-local" id="section3date"></div>

                <div class="decision-box">
                    <div class="decision-title"><i class="fa-solid fa-gavel"></i> APPROVAL ACTION (SECTION 4)</div>
                    <p style="font-size:12px; color:#ccc; margin-bottom:10px;">Please select the next approval method:</p>
                    
                    <select id="approvalMode" class="input decision-select">
                        <option value="Pending">1. ONLINE PROCESS (Send to Deputy Director's Dashboard)</option>
                        <option value="Hardcopy">2. HARDCOPY PROCESS (Completed Physical Form)</option>
                    </select>
                    
                    <div class="info-text">
                        <i class="fa-solid fa-circle-info"></i> <b>Note:</b><br>
                        • <b>Online:</b> Status remains "Pending". Director needs to sign digitally.<br>
                        • <b>Hardcopy:</b>Status automatically becomes "Approve". Digital signature is blanked.
                    </div>
                </div>
            </div>

            <button class="btn-primary" id="saveComplaint">
                <i class="fa-solid fa-floppy-disk"></i> UPDATE & SAVE
            </button>
        </div>
    </main>
</div>

<script>
// --- CONFIG ---
const firebaseConfig={
  apiKey:"AIzaSyDjsNiteoay79tpavm_dfCcKHhRvBfU0Tk",
  authDomain:"e-complaint-8nu9kp.firebaseapp.com",
  projectId:"e-complaint-8nu9kp"
};
if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
const db=firebase.firestore();
const auth=firebase.auth();

// --- AUTH ---
auth.onAuthStateChanged((user) => {
    if (user && user.email.endsWith('@ypkt.gov.my')) {
        listenToComplaints(); 
    } else {
        window.location.href = "login.html";
    }
});
document.getElementById("logout").onclick = () => auth.signOut();

// --- UI UTILS ---
function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('active');
    document.querySelector('.sidebar-overlay').classList.toggle('active');
}
const dt = (t) => {
    if (!t || !t.toDate) return "";
    const d = t.toDate();
    const offset = d.getTimezoneOffset() * 60000;
    const local = new Date(d.getTime() - offset);
    return local.toISOString().slice(0, 16);
};
const displayDate = (t) => {
    if (!t || !t.toDate) return "-";
    return t.toDate().toLocaleString('ms-MY');
}

// --- DATA LOGIC ---
let complaints=[];

function listenToComplaints(){
    db.collection("complaint").onSnapshot((snapshot) => {
        let temp = snapshot.docs.map(d => ({id:d.id, ...d.data()}));
        
        // LOGIC SORTING: Pending naik atas
        complaints = temp.sort((a, b) => {
            const statusA = (a.approvalstatus || "Pending").toLowerCase();
            const statusB = (b.approvalstatus || "Pending").toLowerCase();
            const isPendingA = statusA === "pending";
            const isPendingB = statusB === "pending";

            if (isPendingA && !isPendingB) return -1;
            if (!isPendingA && isPendingB) return 1;

            let dateA = a.updatedAt ? a.updatedAt.seconds : (a.createdAt ? a.createdAt.seconds : 0);
            let dateB = b.updatedAt ? b.updatedAt.seconds : (b.createdAt ? b.createdAt.seconds : 0);
            return dateB - dateA;
        });

        renderTable(complaints);
    });
}

function renderTable(list){
    const div = document.getElementById("complaintList");
    if(list.length === 0) { div.innerHTML = "<div style='padding:20px;text-align:center; color:#888;'>Tiada rekod dijumpai.</div>"; return; }
    
    let h = "<table><thead><tr><th>ID</th><th>REPORTED BY</th><th>ASET</th><th>STATUS</th></tr></thead><tbody>";
    list.forEach(c => {
        let s = c.approvalstatus || "Pending";
        let color = (s === 'Approve') ? '#00ff9d' : (s === 'Reject' ? '#ff4d4d' : '#ccc');
        let icon = (s === 'Approve') ? '<i class="fa-solid fa-check"></i>' : (s === 'Reject' ? '<i class="fa-solid fa-xmark"></i>' : '<i class="fa-solid fa-clock"></i>');
        
        h += `<tr onclick="loadDetail('${c.id}')">
            <td style="color:var(--neon-blue);font-family:'Orbitron'">${c.id}</td>
            <td>${c.lastUser||"-"}</td>
            <td>${c.assettype||"-"}</td>
            <td style="color:${color};font-weight:bold;font-size:11px;">${icon} ${s.toUpperCase()}</td>
        </tr>`;
    });
    h += "</tbody></table>";
    div.innerHTML = h;
}

document.getElementById("searchInput").oninput = (e) => {
    const v = e.target.value.toLowerCase();
    renderTable(complaints.filter(c => 
        c.id.toLowerCase().includes(v) || (c.lastUser||"").toLowerCase().includes(v)
    ));
};

// --- LOAD DETAIL ---
function loadDetail(id){
    const d = complaints.find(c => c.id === id);
    if(!d) return;

    const form = document.getElementById("complaintDetail");
    form.style.display="block";
    form.dataset.id = id;

    const setVal = (eid, val) => document.getElementById(eid).value = val || "";
    
    setVal('assettype', d.assettype);
    setVal('SerialNumber', d.serialNumber);
    setVal('lastUser', d.lastUser);
    setVal('damagedate', displayDate(d.damagedate));
    setVal('damagedescription', d.damagedescription);

    setVal('recommendationsection2', d.recommendationsection2 || d.section2recommendation); 
    setVal('section2nameposition', d.section2nameposition);
    setVal('section2date', displayDate(d.section2date));

    setVal('previousmaintenancecost', d.previousmaintenancecost);
    setVal('estimatedmaintenancecost', d.estimatedmaintenancecost);
    setVal('recommendsection3', d.recommendsection3);
    setVal('section3nameposition', d.section3nameposition);
    
    if(d.section3date) {
        document.getElementById('section3date').value = dt(d.section3date);
    } else {
        const now = new Date();
        const offset = now.getTimezoneOffset() * 60000;
        document.getElementById('section3date').value = new Date(now - offset).toISOString().slice(0, 16);
    }

    // Logic penentuan dropdown
    const isHardcopy = (d.approvalstatus === 'Approve' && !d.approverSignature);
    document.getElementById("approvalMode").value = isHardcopy ? "Hardcopy" : "Pending";

    form.scrollIntoView({behavior: "smooth"});
    
    if(window.innerWidth <= 768) {
        document.getElementById('sidebar').classList.remove('active');
        document.querySelector('.sidebar-overlay').classList.remove('active');
    }
}

// --- SAVE FUNCTION (UPDATED LOGIC HERE) ---
document.getElementById("saveComplaint").onclick = async () => {
    const id = document.getElementById("complaintDetail").dataset.id;
    if(!id) return;

    // --- BARU: VALIDATION LOGIC (WAJIB ISI) ---
    const valPrevCost = document.getElementById('previousmaintenancecost').value.trim();
    const valEstCost = document.getElementById('estimatedmaintenancecost').value.trim();
    const valAction = document.getElementById('recommendsection3').value.trim();
    const valOfficer = document.getElementById('section3nameposition').value.trim();

    if (!valPrevCost || !valEstCost || !valAction || !valOfficer) {
        Swal.fire({
            title: 'REQUIRED FIELDS EMPTY',
            html: `Sila lengkapkan semua maklumat di <b>SEC.3 (Technical Assessment)</b>:<br><br>
            <ul style="text-align:left; font-size:13px; color:#ff4d4d;">
                <li>Previous Cost</li>
                <li>Estimated Cost</li>
                <li>Technical Action / Review</li>
                <li>Name of IT Officer</li>
            </ul>`,
            icon: 'warning',
            confirmButtonColor: '#fbbf24', // Neon Gold color
            confirmButtonText: 'OK, I WILL FILL IT',
            background: 'rgba(2, 6, 23, 0.95)',
            color: '#e2e8f0'
        });
        return; // Hentikan proses simpan jika data tak lengkap
    }
    // --- TAMAT VALIDATION LOGIC ---

    const getVal = (id) => document.getElementById(id).value;
    const mode = document.getElementById("approvalMode").value;

    let updateData = {
        previousmaintenancecost: +getVal('previousmaintenancecost') || 0,
        estimatedmaintenancecost: +getVal('estimatedmaintenancecost') || 0,
        recommendsection3: getVal('recommendsection3'),
        section3nameposition: getVal('section3nameposition'),
        section3date: getVal('section3date') ? firebase.firestore.Timestamp.fromDate(new Date(getVal('section3date'))) : null,
        updatedBy: auth.currentUser.email,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    // --- LOGIC BARU: HANDLE DUA-DUA KEADAAN ---
    if (mode === "Hardcopy") {
        // Kalau pilih HARDCOPY, set Approve terus
        updateData.approvalstatus = "Approve";
        updateData.approvername = "Manual (Hardcopy)";
        updateData.approverposition = "Manual";
        updateData.approvaldate = firebase.firestore.FieldValue.serverTimestamp();
        updateData.approvalcomment = "Selesai secara Manual/Hardcopy.";
        updateData.approverSignature = ""; 
    } else {
        // Kalau pilih ONLINE (Pending), kita kena RESET balik status
        // supaya dia muncul balik kat Dashboard Approver
        updateData.approvalstatus = "Pending";
        updateData.approvername = "";
        updateData.approverposition = "";
        updateData.approvaldate = null; // Buang tarikh approve
        updateData.approvalcomment = ""; 
        updateData.approverSignature = ""; // Buang signature hardcopy
    }

    try {
        await db.collection("complaint").doc(id).set(updateData, {merge:true});
        
        Swal.fire({
            title: 'SYSTEM UPDATED',
            html: '<i class="fa-solid fa-check-circle" style="font-size:40px; color:#00ff9d; margin-bottom:10px;"></i><br><br>Record data has been successfully updated.<br>Status: <b style="color:#00ff9d">' + mode.toUpperCase() + '</b>',
            showConfirmButton: true,
            confirmButtonText: 'CONTINUE'
        });

    } catch(e) {
        Swal.fire({
            title: 'RALAT SISTEM',
            text: e.message,
            icon: 'error',
            confirmButtonColor: '#ff4d4d'
        });
    }
};
</script>

</body>
</html>
