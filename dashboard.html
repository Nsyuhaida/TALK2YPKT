<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard | TALK2YPKT</title>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial,sans-serif;}
body{background:#89CFF0;}
.app{display:flex;min-height:100vh;}
.sidebar{width:240px;background:#1e3a8a;color:white;padding:20px;}
.brand{font-size:20px;font-weight:bold;margin-bottom:30px;text-align:center;}
.nav a{display:block;text-decoration:none;color:white;padding:12px;border-radius:8px;margin-bottom:8px;}
.nav a:hover{background:#2563eb;}
.nav a.active{background:#2563eb;}
.main{flex:1;padding:25px;}
h1{font-size:26px;margin-bottom:20px;}
.card{background:white;padding:20px;border-radius:12px;box-shadow:0 6px 15px rgba(0,0,0,0.1);}
table{width:100%;border-collapse:collapse;margin-top:15px;}
th,td{padding:10px;text-align:left;border-bottom:1px solid #ddd;}
th{background:#1e3a8a;color:white;}
tr:hover{background:#f0f4ff;cursor:pointer;}
#searchInput{padding:8px;width:50%;margin-bottom:10px;border-radius:6px;border:1px solid #ccc;}
input{padding:8px;border-radius:6px;border:1px solid #ccc;}
.loading{text-align:center;margin-top:50px;color:#555;}
.error{color:red;font-weight:bold;text-align:center;margin-top:50px;}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;}
.modal-content{background:#fff;padding:25px;border-radius:12px;width:90%;max-width:700px;max-height:90%;overflow-y:auto;}
.close{float:right;font-size:20px;cursor:pointer;}
h3{color:#1e3a8a;margin-top:15px;border-bottom:1px solid #ddd;padding-bottom:5px;}
/* LOGO SAMA MACAM DASHBOARD */
.logo{
  width:60px;      /* kecil, kemas */
  height:auto;
  display:block;
  margin:0 auto 15px;
}

.header{
  display:flex;justify-content:space-between;
  align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px
}
.input{padding:8px;border-radius:6px;border:1px solid #ccc;width:220px}

.card{
  background:white;padding:22px;border-radius:14px;
  box-shadow:0 6px 15px rgba(0,0,0,0.1);
  margin-bottom:20px;
}

table{width:100%;border-collapse:collapse;margin-top:15px}
th,td{padding:10px;border-bottom:1px solid #ddd;text-align:left}
th{background:#1e3a8a;color:white}

.stats-wrapper{
  display:flex;gap:20px;flex-wrap:wrap;
  justify-content:center;margin-bottom:20px;
}
.stats-card{
  background:#f0f4ff;padding:20px;border-radius:14px;
  min-width:180px;text-align:center;flex:1;
}
.stats-card h2{font-size:32px;color:#1e3a8a}
.stats-card span{font-size:14px;color:#555}

/* Donut section */
.summary-wrapper{
  max-width:720px;
  margin:0 auto;
}
.summary-row{
  display:flex;
  gap:40px;
  align-items:center;
  justify-content:center;
  flex-wrap:wrap;
}
.summary-chart{width:300px}
.summary-kpi{
  background:#f0f4ff;
  padding:22px 30px;
  border-radius:14px;
  text-align:center;
  min-width:220px;
}
.summary-kpi h2{
  font-size:38px;
  color:#1e3a8a;
}
.summary-kpi span{
  font-size:13px;
  color:#555;
}
</style>
</head>

<body>

<div class="app">
<aside class="sidebar">
  <img src="Asset/Logo-Yayasan-Pembangunan-Keluarga-Terengganu (1).png" class="logo">
  <div class="brand">Admin Panel</div>
  <nav class="nav">
    <a href="dashboard.html" class="active">Dashboard</a>
    <a href="complaints.html">Complaints</a>
    <a href="notifications.html">Notifications</a>
    <a href="data-entry.html">Data Entry</a>
    <a href="full-report.html">Full Report</a>
    <a href="faq.html">FAQ</a>
    <a href="#" id="logout">Sign Out</a>
  </nav>
</aside>

<main class="main">

<div class="header">
  <div>
    <h1>Admin Dashboard</h1>
    <p id="welcomeMsg">Welcome user!</p>
  </div>
  <input id="searchInput" class="input" placeholder="Search ID, User, Asset">
</div>

<!-- STAT -->
<div class="stats-wrapper">
  <div class="stats-card">
    <h2 id="totalComplaints">0</h2>
    <span>Total Aduan</span>
  </div>
  <div class="stats-card">
    <h2 id="approveCount">0</h2>
    <span>Approve</span>
  </div>
  <div class="stats-card">
    <h2 id="notApproveCount">0</h2>
    <span>Not Approve</span>
  </div>
</div>

<!-- TABLE -->
<div class="card">
  <h3>Senarai Aduan</h3>
  <table id="dashboardTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>User</th>
        <th>Asset</th>
        <th>Date</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="5">Loading...</td></tr>
    </tbody>
  </table>
</div>

<!-- DONUT + TODAY -->
<div class="card">
  <h3>Status Aduan</h3>
  <div class="summary-wrapper">
    <div class="summary-row">
      <div class="summary-chart">
        <canvas id="statusChart"></canvas>
      </div>
      <div class="summary-kpi">
        <h2 id="todayCount">0</h2>
        <span>Aduan Hari Ini</span>
      </div>
    </div>
  </div>
</div>

</main>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyDjsNiteoay79tpavm_dfCcKHhRvBfU0Tk",
  authDomain:"e-complaint-8nu9kp.firebaseapp.com",
  projectId:"e-complaint-8nu9kp"
});

const db = firebase.firestore();

firebase.auth().onAuthStateChanged(async (user) => {
  if (user) {
    try {
      // ambil dokumen user dari Firestore
      const doc = await firebase.firestore().collection("admin_users").doc(user.uid).get();
      if (doc.exists) {
        const data = doc.data();
        // guna field "username" dari Firestore
        welcomeMsg.textContent = "Welcome, " + (data.username || user.email);
      } else {
        welcomeMsg.textContent = "Welcome, " + user.email;
      }
    } catch (error) {
      console.error("Error fetching user data:", error);
      welcomeMsg.textContent = "Welcome, " + user.email;
    }
  } else {
    welcomeMsg.textContent = "Welcome, guest!";
  }
});


logout.onclick = ()=>{
  firebase.auth().signOut().then(()=>{
    window.location.href="login.html";
  });
};

function formatDate(ts){
  return ts?.toDate ? ts.toDate().toLocaleDateString("ms-MY") : "-";
}

let complaintsData=[];
let statusChart;

async function loadComplaints(){
  const snap = await db.collection("complaint").get();
  complaintsData = snap.docs.map(d=>({ id:d.id, ...d.data() }));
  renderTable();
  renderStats();
  renderDonut();
}

function renderTable(){
  const tb = document.querySelector("#dashboardTable tbody");
  const search = searchInput.value.toLowerCase();
  tb.innerHTML = "";

  complaintsData
    .filter(c =>
      c.id.toLowerCase().includes(search) ||
      (c.lastUser||"").toLowerCase().includes(search) ||
      (c.assettype||"").toLowerCase().includes(search)
    )
    .forEach(c=>{
      tb.innerHTML += `
        <tr>
          <td>${c.id}</td>
          <td>${c.lastUser || "-"}</td>
          <td>${c.assettype || "-"}</td>
          <td>${formatDate(c.damagedate)}</td>
          <td>${c.approvalstatus || "PENDING"}</td>
        </tr>`;
    });
}

function renderStats(){
  totalComplaints.textContent = complaintsData.length;
  approveCount.textContent =
    complaintsData.filter(c=>c.approvalstatus==="Approve").length;
  notApproveCount.textContent =
    complaintsData.filter(c=>c.approvalstatus!=="Approve").length;
}

function renderDonut(){
  const approve = complaintsData.filter(c=>c.approvalstatus==="Approve").length;
  const pending = complaintsData.length - approve;

  if(statusChart) statusChart.destroy();

  statusChart = new Chart(statusChartCanvas = document.getElementById("statusChart"),{
    type:"doughnut",
    data:{
      labels:["Approve","Pending"],
      datasets:[{
        data:[approve,pending],
        backgroundColor:["#16a34a","#f97316"]
      }]
    },
    options:{
      cutout:"60%",
      plugins:{legend:{position:"bottom"}}
    }
  });

  const today = new Date().toLocaleDateString("ms-MY");
  todayCount.textContent = complaintsData.filter(c =>
    c.reportdatesection1?.toDate &&
    c.reportdatesection1.toDate().toLocaleDateString("ms-MY") === today
  ).length;
}

searchInput.oninput = renderTable;

loadComplaints();
</script>

</body>
</html>
