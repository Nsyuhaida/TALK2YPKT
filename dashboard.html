<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard | TALK2YPKT</title>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">

<style>
/* STYLE SAMA MACAM SEBELUM NI (NEXUS THEME) */
:root {
  --neon-blue: #00f3ff; --neon-green: #00ff9d; --neon-gold: #ffaa00; --neon-red: #ff4d4d;
  --bg-dark: #020617; --glass-panel: rgba(15, 23, 42, 0.85); --glass-border: rgba(0, 243, 255, 0.2);
  --text-main: #e2e8f0;
}
* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
body { background: linear-gradient(-45deg, #020617, #0f172a, #1e3a8a, #020617); background-size: 400% 400%; animation: bgMove 20s ease infinite; color: var(--text-main); min-height: 100vh; }
body::before { content: ""; position: fixed; inset: 0; background-image: linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px); background-size: 40px 40px; pointer-events: none; z-index: 0; }
.app { display: flex; min-height: 100vh; position: relative; z-index: 1; }

/* SIDEBAR & NAV */
.sidebar { width: 260px; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(15px); border-right: 1px solid var(--glass-border); padding: 30px 20px; display: flex; flex-direction: column; position: sticky; top: 0; height: 100vh; z-index: 100; transition: 0.3s; }
.logo { width: 70px; display: block; margin: 0 auto 15px; }
.brand { font-family: 'Orbitron'; font-size: 18px; text-align: center; color: var(--neon-blue); margin-bottom: 40px; letter-spacing: 2px; }
.nav a { display: flex; align-items: center; gap: 12px; text-decoration: none; color: #aaa; padding: 14px 18px; border-radius: 12px; margin-bottom: 10px; transition: 0.3s; font-size: 14px; }
.nav a:hover, .nav a.active { background: rgba(0, 243, 255, 0.1); color: #fff; border-color: var(--glass-border); box-shadow: 0 0 15px rgba(0, 243, 255, 0.15); }
#logout { margin-top: auto; color: var(--neon-red); border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px; cursor: pointer; }

/* MAIN */
.main { flex: 1; padding: 30px; overflow-x: hidden; width: 100%; }
.mobile-header { display: none; align-items: center; justify-content: space-between; margin-bottom: 20px; }
.mobile-toggle { background: none; border: none; color: var(--neon-blue); font-size: 24px; cursor: pointer; }
.header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 25px; border-bottom: 1px solid var(--glass-border); padding-bottom: 15px; }
.header h1 { font-family: 'Orbitron'; font-size: 24px; color: #fff; }
.input { padding: 10px 20px; border-radius: 50px; border: 1px solid var(--glass-border); background: rgba(0,0,0,0.3); color: #fff; width: 250px; outline: none; }

/* STATS */
.stats-wrapper { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
.stats-card { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border); text-align: center; transition: 0.3s; }
.stats-card:hover { transform: translateY(-5px); box-shadow: 0 5px 20px rgba(0,0,0,0.4); }
.stats-card h2 { font-family: 'Orbitron'; font-size: 36px; color: #fff; margin-bottom: 5px; }
.stats-card span { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; }

/* TABLE */
.card { background: var(--glass-panel); padding: 20px; border-radius: 16px; margin-bottom: 25px; border: 1px solid var(--glass-border); }
table { width: 100%; border-collapse: separate; border-spacing: 0 5px; min-width: 600px; }
th { text-align: left; padding: 12px; color: #aaa; font-size: 11px; text-transform: uppercase; }
td { background: rgba(255,255,255,0.03); padding: 12px; color: #fff; font-size: 13px; }
td:first-child { border-top-left-radius: 8px; border-bottom-left-radius: 8px; }
td:last-child { border-top-right-radius: 8px; border-bottom-right-radius: 8px; }

/* BADGES */
.badge-table { padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; white-space: nowrap; }
.badge-online { background: rgba(0, 255, 157, 0.15); color: var(--neon-green); border: 1px solid var(--neon-green); } /* Approved Online */
.badge-hardcopy { background: rgba(255, 170, 0, 0.15); color: var(--neon-gold); border: 1px solid var(--neon-gold); } /* Approved Hardcopy */
.badge-it-done { background: rgba(0, 243, 255, 0.15); color: var(--neon-blue); border: 1px solid var(--neon-blue); } /* Section 3 Done */
.badge-pending { background: rgba(255, 77, 77, 0.15); color: var(--neon-red); border: 1px solid var(--neon-red); } /* Pending */

/* KPI & CHART */
.summary-wrapper { display: flex; justify-content: center; align-items: center; gap:40px; flex-wrap: wrap; height: 300px; }
.summary-kpi { text-align: center; padding: 20px; border-radius: 50%; border: 2px dashed var(--glass-border); width: 160px; height: 160px; display: flex; flex-direction: column; justify-content: center; animation: rotateBorder 20s linear infinite reverse; }
.summary-kpi-inner { animation: rotateBorder 20s linear infinite; }
.summary-kpi h2 { font-size: 36px; color: #fff; font-family: 'Orbitron'; }
.summary-kpi span { font-size: 10px; color: var(--neon-blue); text-transform: uppercase; }

@keyframes bgMove { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
@keyframes rotateBorder { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
@media (max-width: 768px) { .sidebar { position: fixed; left: -100%; width: 80%; } .sidebar.active { left: 0; } .mobile-header { display: flex; } .header { flex-direction: column; align-items: flex-start; } .input { width: 100%; } }
</style>
</head>
<body>

<div class="app">
  <div class="sidebar-overlay" onclick="toggleSidebar()" style="position:fixed; inset:0; background:rgba(0,0,0,0.7); display:none; z-index:90;"></div>

  <aside class="sidebar" id="sidebar">
    <img src="Asset/Logo-Yayasan-Pembangunan-Keluarga-Terengganu (1).png" class="logo">
    <div class="brand">TALK2YPKT ADMIN</div>
    <div class="nav">
      <a href="dashboard.html" class="active"><i class="fa-solid fa-chart-line"></i> Dashboard</a>
      <a href="complaints.html"><i class="fa-solid fa-file-shield"></i> Complaints</a>
      <a href="notifications.html"><i class="fa-solid fa-bell"></i> Notifications</a>
      <a href="data-entry.html"><i class="fa-solid fa-database"></i> Data Entry</a>
      <a href="full-report.html"><i class="fa-solid fa-clipboard-list"></i> Full Report</a>
      <a href="faq.html"><i class="fa-solid fa-circle-question"></i> FAQ</a>
    </div>
    <a id="logout"><i class="fa-solid fa-power-off"></i> Sign Out</a>
  </aside>

  <main class="main">
    <div class="mobile-header">
        <button class="mobile-toggle" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
        <div style="font-family:'Orbitron'; font-weight:bold; color:var(--neon-blue);">DASHBOARD</div>
        <div style="width:24px;"></div>
    </div>

    <div class="header">
      <div>
        <h1>COMMAND CENTER</h1>
        <p>System Overview & Status</p>
      </div>
      <input id="searchInput" class="input" placeholder="Search ID / Asset / User...">
    </div>

    <div class="stats-wrapper">
      <div class="stats-card">
        <h2 id="cTotal">0</h2>
        <span style="color:var(--neon-blue);">TOTAL COMPLAINTS</span>
      </div>
      <div class="stats-card" style="border-color: var(--neon-green);">
        <h2 id="cOnline" style="color:var(--neon-green);">0</h2>
        <span style="color:var(--neon-green);">APPROVED (ONLINE)</span>
      </div>
      <div class="stats-card" style="border-color: var(--neon-gold);">
        <h2 id="cHardcopy" style="color:var(--neon-gold);">0</h2>
        <span style="color:var(--neon-gold);">APPROVED (HARDCOPY)</span>
      </div>
      <div class="stats-card" style="border-color: var(--neon-red);">
        <h2 id="cPending" style="color:var(--neon-red);">0</h2>
        <span style="color:var(--neon-red);">PENDING / INCOMPLETE</span>
      </div>
    </div>

    <div class="card">
      <h3>LIVE DATA STREAM</h3>
      <div style="overflow-x:auto;">
        <table id="dashboardTable">
          <thead>
            <tr>
              <th>REF ID</th>
              <th>LAST USER</th>
              <th>ASSET TYPE</th>
              <th>SEC 3 (IT DEPT)</th>
              <th>SEC 4 (APPROVAL)</th>
            </tr>
          </thead>
          <tbody><tr><td colspan="5" style="text-align:center;">Connecting...</td></tr></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h3>SYSTEM DIAGNOSTICS</h3>
      <div class="summary-wrapper">
        <div style="width: 250px; height: 250px;">
            <canvas id="statusChart"></canvas>
        </div>
        
        <div class="summary-kpi" id="kpiCircle">
            <div class="summary-kpi-inner">
                <h2 id="efficiencyValue" style="transition: color 0.5s ease;">0%</h2>
                <span id="efficiencyLabel">COMPLETION</span>
            </div>
        </div>
      </div>
    </div>

  </main>
</div>

<script>
// CONFIG
const firebaseConfig={
  apiKey:"AIzaSyDjsNiteoay79tpavm_dfCcKHhRvBfU0Tk",
  authDomain:"e-complaint-8nu9kp.firebaseapp.com",
  projectId:"e-complaint-8nu9kp"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();
const auth=firebase.auth();

function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('active');
    document.querySelector('.sidebar-overlay').style.display = document.getElementById('sidebar').classList.contains('active') ? 'block' : 'none';
}

auth.onAuthStateChanged((user) => {
    if (user && user.email.endsWith('@ypkt.gov.my')) {
        listenToData();
    } else {
        window.location.href = "login.html";
    }
});
document.getElementById("logout").onclick = () => auth.signOut();

// --- LOGIC UTAMA ---
let chartInstance;
let complaintsData = [];

function listenToData() {
    db.collection("complaint").orderBy("updatedAt", "desc").onSnapshot(snap => {
        complaintsData = snap.docs.map(d => ({id:d.id, ...d.data()}));
        processData();
    });
}

function processData() {
    const total = complaintsData.length;
    
    // LOGIC: Approved Online = Status Approve DAN Ada Signature
    const online = complaintsData.filter(c => c.approvalstatus === 'Approve' && c.approverSignature).length;
    
    // LOGIC: Approved Hardcopy = Status Approve TAPI Tiada Signature
    const hardcopy = complaintsData.filter(c => c.approvalstatus === 'Approve' && !c.approverSignature).length;
    
    // LOGIC: Pending = Semua yang BUKAN Approve (Termasuk Sec 3 belum siap, atau Sec 4 Reject/Pending)
    const pending = total - (online + hardcopy);

    // Update UI Cards
    updateValue("cTotal", total);
    updateValue("cOnline", online);
    updateValue("cHardcopy", hardcopy);
    updateValue("cPending", pending);

    // Update Table & Chart
    renderTable();
    renderChart(online, hardcopy, pending);
    
    // Update Stylized Circle (Completion Rate)
    // Completed = Online + Hardcopy. Total = Total.
    updateKPI(online + hardcopy, total);
}

function renderTable() {
    const tb = document.querySelector("#dashboardTable tbody");
    const search = document.getElementById("searchInput").value.toLowerCase();
    tb.innerHTML = "";

    const list = complaintsData.filter(c => c.id.toLowerCase().includes(search) || (c.lastUser||"").toLowerCase().includes(search));

    if(list.length === 0) { tb.innerHTML = `<tr><td colspan="5" style="text-align:center;">No data found</td></tr>`; return; }

    list.forEach(c => {
        // 1. CHECK SECTION 3 (IT DONE?)
        // Kalau section3date wujud -> IT DONE. Kalau tak -> IT NOT DONE (Pending).
        let sec3Badge = c.section3date 
            ? `<span class="badge-table badge-it-done"><i class="fa-solid fa-check"></i> IT DONE</span>` 
            : `<span class="badge-table badge-pending"><i class="fa-solid fa-clock"></i> NOT DONE</span>`;

        // 2. CHECK SECTION 4 (APPROVAL MODE)
        let sec4Badge = "-";
        if (c.approvalstatus === 'Approve') {
            if(c.approverSignature) {
                sec4Badge = `<span class="badge-table badge-online"><i class="fa-solid fa-wifi"></i> ONLINE OK</span>`;
            } else {
                sec4Badge = `<span class="badge-table badge-hardcopy"><i class="fa-solid fa-file-signature"></i> HARDCOPY</span>`;
            }
        } else if (c.approvalstatus === 'Reject') {
             sec4Badge = `<span class="badge-table badge-pending">REJECTED</span>`;
        } else {
             sec4Badge = `<span class="badge-table badge-pending">PENDING</span>`;
        }

        tb.innerHTML += `
            <tr>
                <td style="color:var(--neon-blue); font-family:'Orbitron'">${c.id}</td>
                <td>${c.lastUser || "-"}</td>
                <td>${c.assettype || "-"}</td>
                <td>${sec3Badge}</td>
                <td>${sec4Badge}</td>
            </tr>
        `;
    });
}
document.getElementById("searchInput").oninput = renderTable;

// CHART
function renderChart(online, hardcopy, pending) {
    const ctx = document.getElementById('statusChart').getContext('2d');
    if(chartInstance) chartInstance.destroy();

    chartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Approve Online', 'Approve Hardcopy', 'Pending'],
            datasets: [{
                data: [online, hardcopy, pending],
                backgroundColor: ['#00ff9d', '#ffaa00', '#ff4d4d'],
                borderColor: '#020617',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: { legend: { position: 'bottom', labels: { color: '#fff', usePointStyle: true } } }
        }
    });
}

// KPI CIRCLE ANIMATION
function updateKPI(completed, total) {
    let percent = 0;
    if(total > 0) percent = Math.round((completed / total) * 100);
    
    const val = document.getElementById("efficiencyValue");
    const circle = document.getElementById("kpiCircle");
    
    val.textContent = percent + "%";
    
    // Warna ikut tahap siap
    if(percent >= 80) {
        val.style.color = "#00ff9d"; circle.style.borderColor = "#00ff9d";
    } else if (percent >= 50) {
        val.style.color = "#ffaa00"; circle.style.borderColor = "#ffaa00";
    } else {
        val.style.color = "#ff4d4d"; circle.style.borderColor = "#ff4d4d";
    }
}

function updateValue(id, val){ document.getElementById(id).innerText = val; }
</script>

</body>
</html>
