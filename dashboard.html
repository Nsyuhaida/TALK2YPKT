<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard | TALK2YPKT</title>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">

<style>
/* --- NEXUS THEME --- */
:root {
  --neon-blue: #00f3ff;
  --neon-green: #00ff9d;
  --neon-gold: #ffaa00; /* Warna utk Hardcopy */
  --neon-red: #ff4d4d;
  --bg-dark: #020617;
  --glass-panel: rgba(15, 23, 42, 0.85);
  --glass-border: rgba(0, 243, 255, 0.2);
  --text-main: #e2e8f0;
}

* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }

body {
  background: linear-gradient(-45deg, #020617, #0f172a, #1e3a8a, #020617);
  background-size: 400% 400%; animation: bgMove 20s ease infinite;
  color: var(--text-main); min-height: 100vh;
}
body::before {
  content: ""; position: fixed; inset: 0;
  background-image: linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px),
  linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
  background-size: 40px 40px; pointer-events: none; z-index: 0;
}

.app { display: flex; min-height: 100vh; position: relative; z-index: 1; }

/* SIDEBAR */
.sidebar {
  width: 260px; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(15px);
  border-right: 1px solid var(--glass-border); padding: 30px 20px;
  display: flex; flex-direction: column; position: sticky; top: 0; height: 100vh; z-index: 100;
  transition: 0.3s;
}
.logo { width: 70px; display: block; margin: 0 auto 15px; }
.brand { font-family: 'Orbitron'; font-size: 18px; text-align: center; color: var(--neon-blue); margin-bottom: 40px; letter-spacing: 2px; }
.nav a {
  display: flex; align-items: center; gap: 12px; text-decoration: none; color: #aaa;
  padding: 14px 18px; border-radius: 12px; margin-bottom: 10px; transition: 0.3s; font-size: 14px;
}
.nav a:hover, .nav a.active { background: rgba(0, 243, 255, 0.1); color: #fff; border-color: var(--glass-border); box-shadow: 0 0 15px rgba(0, 243, 255, 0.15); }
#logout { margin-top: auto; color: var(--neon-red); border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px; }

/* MAIN */
.main { flex: 1; padding: 30px; overflow-x: hidden; width: 100%; }
.mobile-header { display: none; align-items: center; justify-content: space-between; margin-bottom: 20px; }
.mobile-toggle { background: none; border: none; color: var(--neon-blue); font-size: 24px; cursor: pointer; }

/* STATS CARDS (GRID 4) */
.stats-wrapper { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
.stats-card {
  background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px);
  padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);
  text-align: center; transition: 0.3s; position: relative; overflow: hidden;
}
.stats-card:hover { transform: translateY(-5px); box-shadow: 0 5px 20px rgba(0,0,0,0.4); }
.stats-card h2 { font-family: 'Orbitron'; font-size: 36px; color: #fff; margin-bottom: 5px; }
.stats-card span { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; }

/* TABLE */
.card { background: var(--glass-panel); padding: 20px; border-radius: 16px; margin-bottom: 25px; border: 1px solid var(--glass-border); }
.card h3 { font-family: 'Orbitron'; color: var(--neon-blue); margin-bottom: 15px; font-size: 16px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
table { width: 100%; border-collapse: separate; border-spacing: 0 5px; }
th { text-align: left; padding: 12px; color: #aaa; font-size: 11px; text-transform: uppercase; }
td { background: rgba(255,255,255,0.03); padding: 12px; color: #fff; font-size: 13px; }
td:first-child { border-top-left-radius: 8px; border-bottom-left-radius: 8px; }
td:last-child { border-top-right-radius: 8px; border-bottom-right-radius: 8px; }

/* STATUS BADGES */
.badge { padding: 5px 10px; border-radius: 4px; font-size: 10px; font-weight: bold; letter-spacing: 0.5px; text-transform: uppercase; }
.badge-online { background: rgba(0, 255, 157, 0.15); color: #00ff9d; border: 1px solid #00ff9d; }
.badge-manual { background: rgba(255, 170, 0, 0.15); color: #ffaa00; border: 1px solid #ffaa00; }
.badge-pending { background: rgba(255, 77, 77, 0.15); color: #ff4d4d; border: 1px solid #ff4d4d; }
.badge-neutral { background: rgba(255, 255, 255, 0.1); color: #ccc; border: 1px solid #666; }

/* CHART AREA */
.summary-wrapper { display: flex; justify-content: center; align-items: center; height: 300px; }

@keyframes bgMove { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
@media (max-width: 768px) {
    .sidebar { position: fixed; left: -100%; width: 80%; }
    .sidebar.active { left: 0; }
    .mobile-header { display: flex; }
}
</style>
</head>
<body>

<div class="app">
  <div class="sidebar-overlay" onclick="toggleSidebar()" style="position:fixed; inset:0; background:rgba(0,0,0,0.7); display:none; z-index:90;"></div>

  <aside class="sidebar" id="sidebar">
    <img src="Asset/Logo-Yayasan-Pembangunan-Keluarga-Terengganu (1).png" class="logo">
    <div class="brand">TALK2YPKT ADMIN</div>
    <div class="nav">
      <a href="dashboard.html" class="active"><i class="fa-solid fa-chart-line"></i> Dashboard</a>
      <a href="complaints.html"><i class="fa-solid fa-file-shield"></i> Complaints</a>
      <a href="notifications.html"><i class="fa-solid fa-bell"></i> Notifications</a>
      <a href="data-entry.html"><i class="fa-solid fa-database"></i> Data Entry</a>
      <a href="full-report.html"><i class="fa-solid fa-clipboard-list"></i> Full Report</a>
      <a href="faq.html"><i class="fa-solid fa-circle-question"></i> FAQ</a>
    </div>
    <a id="logout"><i class="fa-solid fa-power-off"></i> Sign Out</a>
  </aside>

  <main class="main">
    <div class="mobile-header">
        <button class="mobile-toggle" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
        <div style="font-family:'Orbitron'; font-weight:bold; color:var(--neon-blue);">DASHBOARD</div>
        <div style="width:24px;"></div>
    </div>

    <div class="stats-wrapper">
      <div class="stats-card">
        <h2 id="cTotal">0</h2>
        <span style="color:var(--neon-blue);">TOTAL REPORTS</span>
      </div>
      <div class="stats-card" style="border-color: var(--neon-green);">
        <h2 id="cOnline" style="color:var(--neon-green);">0</h2>
        <span style="color:var(--neon-green);">APPROVED (ONLINE)</span>
      </div>
      <div class="stats-card" style="border-color: var(--neon-gold);">
        <h2 id="cHardcopy" style="color:var(--neon-gold);">0</h2>
        <span style="color:var(--neon-gold);">APPROVED (HARDCOPY)</span>
      </div>
      <div class="stats-card" style="border-color: var(--neon-red);">
        <h2 id="cPending" style="color:var(--neon-red);">0</h2>
        <span style="color:var(--neon-red);">PENDING / INCOMPLETE</span>
      </div>
    </div>

    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
          <h3>REPORT STATUS BREAKDOWN</h3>
          <input id="searchInput" placeholder="Search ID..." style="background:rgba(0,0,0,0.3); border:1px solid #444; color:#fff; padding:5px 10px; border-radius:5px;">
      </div>
      <div style="overflow-x:auto;">
        <table id="dashboardTable">
          <thead>
            <tr>
              <th>REF ID</th>
              <th>ASSET</th>
              <th>SEC 3 (IT STATUS)</th>
              <th>SEC 4 (APPROVAL MODE)</th>
              <th>DATE</th>
            </tr>
          </thead>
          <tbody><tr><td colspan="5" style="text-align:center;">Loading...</td></tr></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h3>STATISTICS OVERVIEW</h3>
      <div class="summary-wrapper">
        <canvas id="statusChart"></canvas>
      </div>
    </div>

  </main>
</div>

<script>
// --- CONFIG ---
const firebaseConfig={
  apiKey:"AIzaSyDjsNiteoay79tpavm_dfCcKHhRvBfU0Tk",
  authDomain:"e-complaint-8nu9kp.firebaseapp.com",
  projectId:"e-complaint-8nu9kp"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();
const auth=firebase.auth();

function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('active');
    document.querySelector('.sidebar-overlay').style.display = document.getElementById('sidebar').classList.contains('active') ? 'block' : 'none';
}

auth.onAuthStateChanged((user) => {
    if (user && user.email.endsWith('@ypkt.gov.my')) {
        listenToData();
    } else {
        window.location.href = "login.html";
    }
});
document.getElementById("logout").onclick = () => auth.signOut();

// --- DATA LOGIC ---
let chartInstance;
let complaintsData = [];

function listenToData() {
    db.collection("complaint").orderBy("updatedAt", "desc").onSnapshot(snap => {
        complaintsData = snap.docs.map(d => ({id:d.id, ...d.data()}));
        processData();
    });
}

function processData() {
    // 1. KIRA COUNT (LOGIC BARU)
    const total = complaintsData.length;
    
    // Approved Online: Status Approve DAN Ada Signature
    const online = complaintsData.filter(c => c.approvalstatus === 'Approve' && c.approverSignature).length;
    
    // Approved Hardcopy: Status Approve TAPI Tiada Signature
    const hardcopy = complaintsData.filter(c => c.approvalstatus === 'Approve' && !c.approverSignature).length;
    
    // Pending: Apa-apa yang bukan Approve (termasuk Reject atau belum isi)
    const pending = total - (online + hardcopy);

    // Update UI Cards
    animateValue("cTotal", total);
    animateValue("cOnline", online);
    animateValue("cHardcopy", hardcopy);
    animateValue("cPending", pending);

    // Update Chart
    renderChart(online, hardcopy, pending);

    // Update Table
    renderTable();
}

function renderChart(online, hardcopy, pending) {
    const ctx = document.getElementById('statusChart').getContext('2d');
    if(chartInstance) chartInstance.destroy();

    chartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Approved Online', 'Approved Hardcopy', 'Pending/Incomplete'],
            datasets: [{
                data: [online, hardcopy, pending],
                backgroundColor: ['#00ff9d', '#ffaa00', '#ff4d4d'], // Hijau, Kuning/Emas, Merah
                borderWidth: 0,
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { color: '#fff', usePointStyle: true, padding: 20 } }
            },
            cutout: '70%'
        }
    });
}

function renderTable() {
    const tb = document.querySelector("#dashboardTable tbody");
    const search = document.getElementById("searchInput").value.toLowerCase();
    tb.innerHTML = "";

    const list = complaintsData.filter(c => c.id.toLowerCase().includes(search) || (c.assettype||"").toLowerCase().includes(search));

    if(list.length === 0) { tb.innerHTML = `<tr><td colspan="5" style="text-align:center;">No data found</td></tr>`; return; }

    list.forEach(c => {
        // LOGIC STATUS SECTION 3 (IT)
        // Kalau Section 3 date ada, maknanya dah isi. Kalau tak, Pending.
        let sec3Status = c.section3date ? 
            `<span class="badge badge-online">COMPLETED</span>` : 
            `<span class="badge badge-pending">PENDING IT</span>`;

        // LOGIC STATUS SECTION 4 (ENC ASHRI)
        let sec4Status = "-";
        if(c.approvalstatus === 'Approve') {
            if(c.approverSignature) {
                sec4Status = `<span class="badge badge-online"><i class="fa-solid fa-wifi"></i> ONLINE APPROVED</span>`;
            } else {
                sec4Status = `<span class="badge badge-manual"><i class="fa-solid fa-file-signature"></i> HARDCOPY APPROVED</span>`;
            }
        } else if (c.approvalstatus === 'Reject') {
             sec4Status = `<span class="badge badge-pending">REJECTED</span>`;
        } else {
             sec4Status = `<span class="badge badge-neutral">PENDING APPROVAL</span>`;
        }

        tb.innerHTML += `
            <tr>
                <td style="color:var(--neon-blue); font-family:'Orbitron'">${c.id}</td>
                <td>${c.assettype || "-"}</td>
                <td>${sec3Status}</td>
                <td>${sec4Status}</td>
                <td style="color:#aaa; font-size:11px;">${c.updatedAt ? new Date(c.updatedAt.toDate()).toLocaleDateString() : "-"}</td>
            </tr>
        `;
    });
}

document.getElementById("searchInput").oninput = renderTable;

// Animation effect for numbers
function animateValue(id, end) {
    const obj = document.getElementById(id);
    let start = 0;
    const duration = 1000;
    let startTimestamp = null;
    const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        obj.innerHTML = Math.floor(progress * (end - start) + start);
        if (progress < 1) { window.requestAnimationFrame(step); }
    };
    window.requestAnimationFrame(step);
}
</script>

</body>
</html>
